

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VyOS cloud-init &mdash; VyOS 1.5.x (circinus) documentation</title>
      <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../static/vyos-logo-icon.png"/>
      <script src="../static/jquery.js?v=5d32c60e"></script>
      <script src="../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../static/documentation_options.js?v=719443cf"></script>
      <script src="../static/doctools.js?v=9bcbadda"></script>
      <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../static/design-tabs.js?v=f930bc37"></script>
    <script src="../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="pyvyos" href="vyos-pyvyos.html" />
    <link rel="prev" title="Command Scripting" href="command-scripting.html" />
    <style>#vyos-header-iframe{position:fixed;top:0;left:0;right:0;z-index:999999999;width:100%;border:none}</style>
    <style>#vyos-footer-iframe{width:100%;border:none}</style>
    <link href="../static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="../static/css/lists.css" rel="stylesheet" type="text/css">
    <link href="../static/css/hints.css" rel="stylesheet" type="text/css">
    <link href="../static/css/headers.css" rel="stylesheet" type="text/css">
    <link href="../static/css/breadcrumbs.css" rel="stylesheet" type="text/css">
    <link href="../static/css/linkButtons.css" rel="stylesheet" type="text/css">
    <link href="../static/css/text.css" rel="stylesheet" type="text/css">
    <link href="../static/css/leftSidebar.css" rel="stylesheet" type="text/css">
    <link href="../static/css/scrolls.css" rel="stylesheet" type="text/css">
    <link href="../static/css/tables.css" rel="stylesheet" type="text/css">
    <link href="../static/css/installation/running-on-bare-metal.css" rel="stylesheet" type="text/css">
    <link href="../static/css/code-snippets.css" rel="stylesheet" type="text/css">
    <link href="../static/css/separate-commands.css" rel="stylesheet" type="text/css">
    <link href="../static/css/configuration/index.css" rel="stylesheet" type="text/css">
    <link href="../static/css/datatables.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="../static/js/datatables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/tables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/codecopier.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/sidebar.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/footer.js"></script>
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VyOS
              <img src="../static/vyos-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introducing/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introducing/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation and Image Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html#configuration-overview">Configuration Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adminguide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/index.html">Operation Mode</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">VyOS Automation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vyos-api.html">VyOS API</a></li>
<li class="toctree-l2"><a class="reference internal" href="vyos-ansible.html">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="terraform/index.html">VyOS Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="vyos-napalm.html">Napalm</a></li>
<li class="toctree-l2"><a class="reference internal" href="vyos-netmiko.html">Netmiko</a></li>
<li class="toctree-l2"><a class="reference internal" href="vyos-salt.html">Salt</a></li>
<li class="toctree-l2"><a class="reference internal" href="command-scripting.html">Command Scripting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">VyOS cloud-init</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#config-sources">Config Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-data">User-data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cloud-config-modules">Cloud-config modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cloud-config-file-format">cloud-config file format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initial-configuration">Initial Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#system-defaults-fallbacks">System Defaults/Fallbacks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#command-execution-at-initial-boot">Command Execution at Initial Boot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nocloud">NoCloud</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cloud-init-on-proxmox">Cloud-init on Proxmox</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generate-qcow-image">Generate qcow image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prepare-cloud-init-files">Prepare cloud-init files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-seed-iso">Create seed.iso</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-vm">Creating the VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#power-on-vm-and-verifications">Power on VM and verifications</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vyos-pyvyos.html">pyvyos</a></li>
<li class="toctree-l2"><a class="reference internal" href="vyos-govyos.html">go-vyos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configexamples/index.html">Configuration Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configexamples/index.html#configuration-blueprints-autotest">Configuration Blueprints (autotest)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/build-vyos.html">Build VyOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/issues-features.html">Issues/Feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/upstream-packages.html">Upstream packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Write Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VyOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">VyOS Automation</a></li>
      <li class="breadcrumb-item active">VyOS cloud-init</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../sources/automation/cloud-init.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="vyos-cloud-init">
<span id="cloud-init"></span><h1>VyOS cloud-init<a class="headerlink" href="#vyos-cloud-init" title="Link to this heading"></a></h1>
<p>Cloud and virtualized instances of VyOS are initialized using the
industry-standard cloud-init. Via cloud-init, the system performs tasks such as
injecting SSH keys and configuring the network. In addition, the user can
supply a custom configuration at the time of instance launch.</p>
<section id="config-sources">
<h2>Config Sources<a class="headerlink" href="#config-sources" title="Link to this heading"></a></h2>
<p>VyOS support three types of config sources.</p>
<ul class="simple">
<li><p>Metadata - Metadata is sourced by the cloud platform or hypervisor.
In some clouds, there is implemented as an HTTP endpoint at
<code class="docutils literal notranslate"><span class="pre">http://169.254.169.254</span></code>.</p></li>
<li><p>Network configuration - This config source informs the system about the
network settings like IP addresses, routes, DNS. Available only in several
cloud and virtualization platforms.</p></li>
<li><p>User-data - User-data is specified by the user. This config source offers
the ability to insert any CLI configuration commands into the configuration
before   the first boot.</p></li>
</ul>
</section>
<section id="user-data">
<h2>User-data<a class="headerlink" href="#user-data" title="Link to this heading"></a></h2>
<p>Major cloud providers offer a means of providing user-data at the time of
instance launch. It can be provided as plain text or as base64-encoded text,
depending on cloud provider. Also, it can be compressed using gzip, which makes
sense with a long configuration commands list, because of the hard limit to
~16384 bytes for the whole user-data.</p>
<p>The easiest way to configure the system via user-data is the Cloud-config
syntax described below.</p>
</section>
<section id="cloud-config-modules">
<h2>Cloud-config modules<a class="headerlink" href="#cloud-config-modules" title="Link to this heading"></a></h2>
<p>In VyOS, by default, enables only two modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">write_files</span></code> - this module allows to insert any files into the filesystem
before the first boot, for example, pre-generated encryption keys,
certificates, or even a whole <code class="docutils literal notranslate"><span class="pre">config.boot</span></code> file. The format is described
in the cloudinit documentation <a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html#writing-out-arbitrary-files">Cloud-init-write_files</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vyos_userdata</span></code> - the module accepts a list of CLI configuration commands
in a <code class="docutils literal notranslate"><span class="pre">vyos_config_commands</span></code> section, which gives an easy way to configure
the system during deployment.</p></li>
</ul>
</section>
<section id="cloud-config-file-format">
<h2>cloud-config file format<a class="headerlink" href="#cloud-config-file-format" title="Link to this heading"></a></h2>
<p>A cloud-config document is written in YAML. The file must begin
with <code class="docutils literal notranslate"><span class="pre">#cloud-config</span></code> line. The only supported top-level keys are
<code class="docutils literal notranslate"><span class="pre">vyos_config_commands</span></code> and <code class="docutils literal notranslate"><span class="pre">write_files</span></code>. The use of these keys is
described in the following two sections.</p>
</section>
<section id="initial-configuration">
<h2>Initial Configuration<a class="headerlink" href="#initial-configuration" title="Link to this heading"></a></h2>
<p>The key used to designate a VyOS configuration is <code class="docutils literal notranslate"><span class="pre">vyos_config_commands</span></code>.
What follows is VyOS configuration using the “set-style” syntax. Both “set”
and “delete” commands are supported.</p>
<p>Commands requirements:</p>
<ul class="simple">
<li><p>One command per line.</p></li>
<li><p>If command ends in a value, it must be inside single quotes.</p></li>
<li><p>A single-quote symbol is not allowed inside command or value.</p></li>
</ul>
<p>The commands list produced by the <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">configuration</span> <span class="pre">commands</span></code> command
on a VyOS router should comply with all the requirements, so it is easy
to get a proper commands list by copying it from another router.</p>
<p>The configuration specified in the cloud-config document overwrites default
configuration values and values configured via Metadata.</p>
<p>After the <code class="docutils literal notranslate"><span class="pre">vyos_config_commands</span></code> are executed, cloud-init will
automatically  perform a <code class="docutils literal notranslate"><span class="pre">commit</span></code> and <code class="docutils literal notranslate"><span class="pre">save</span></code> operation.</p>
<p>Here is an example cloud-config that appends configuration at the time of
first boot.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1">#cloud-config</span>
<span class="nt">vyos_config_commands</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set system host-name &#39;vyos-prod-ashburn&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set service ntp server 1.pool.ntp.org</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set service ntp server 2.pool.ntp.org</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">delete interfaces ethernet eth1 address &#39;dhcp&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set interfaces ethernet eth1 address &#39;192.0.2.247/24&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set protocols static route 198.51.100.0/24 next-hop &#39;192.0.2.1&#39;</span>
</pre></div>
</div>
<section id="system-defaults-fallbacks">
<h3>System Defaults/Fallbacks<a class="headerlink" href="#system-defaults-fallbacks" title="Link to this heading"></a></h3>
<p>These are the VyOS defaults and fallbacks.</p>
<ul class="simple">
<li><p>SSH is configured on port 22.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vyos</span></code>/<code class="docutils literal notranslate"><span class="pre">vyos</span></code> credentials if no others specified by data source.</p></li>
<li><p>DHCP on first Ethernet interface if no network configuration is provided.</p></li>
</ul>
<p>All of these can be overridden using the configuration in user-data.</p>
</section>
</section>
<section id="command-execution-at-initial-boot">
<h2>Command Execution at Initial Boot<a class="headerlink" href="#command-execution-at-initial-boot" title="Link to this heading"></a></h2>
<p>VyOS supports the execution of operational commands and linux commands at
initial boot. This is accomplished using <code class="docutils literal notranslate"><span class="pre">write_files</span></code> to certain
files in the /opt/vyatta/etc/config/scripts directory. Commands specified
in opt/vyatta/etc/config/scripts/vyos-preconfig-bootup.script are executed
prior to configuration. The
/opt/vyatta/etc/config/scripts/vyos-postconfig-bootup.script file contains
commands to be executed after configuration. In both cases, commands are
executed as the root user.</p>
<p>Note that the /opt/vyatta/etc/config is used instead of the /config/scripts
directory referenced in the <a class="reference internal" href="command-scripting.html#command-scripting"><span class="std std-ref">Command Scripting</span></a> section of the
documentation because the /config/script directory isn’t mounted when the
<code class="docutils literal notranslate"><span class="pre">write_files</span></code> module executes.</p>
<p>The following example shows how to execute commands after the initial
configuration.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1">#cloud-config</span>
<span class="nt">write_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/vyatta/etc/config/scripts/vyos-postconfig-bootup.script</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root:vyattacfg</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0775&#39;</span>
<span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">#!/bin/vbash</span>
<span class="w">      </span><span class="no">source /opt/vyatta/etc/functions/script-template</span>
<span class="w">      </span><span class="no">filename=/tmp/bgp_status_`date +&quot;%Y_%m_%d_%I_%M_%p&quot;`.log</span>
<span class="w">      </span><span class="no">run show ip bgp summary &gt;&gt; $filename</span>
</pre></div>
</div>
<p>If you need to gather information from linux commands to configure VyOS, you
can execute commands and then configure VyOS in the same script.</p>
<p>The following example sets the hostname based on the instance identifier
obtained from the EC2 metadata service.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1">#cloud-config</span>
<span class="nt">write_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/vyatta/etc/config/scripts/vyos-postconfig-bootup.script</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root:vyattacfg</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0775&#39;</span>
<span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">#!/bin/vbash</span>
<span class="w">      </span><span class="no">source /opt/vyatta/etc/functions/script-template</span>
<span class="w">      </span><span class="no">hostname=`curl -s http://169.254.169.254/latest/meta-data/instance-id`</span>
<span class="w">      </span><span class="no">configure</span>
<span class="w">      </span><span class="no">set system host-name $hostname</span>
<span class="w">      </span><span class="no">commit</span>
<span class="w">      </span><span class="no">exit</span>
</pre></div>
</div>
</section>
<section id="nocloud">
<h2>NoCloud<a class="headerlink" href="#nocloud" title="Link to this heading"></a></h2>
<p>Injecting configuration data is not limited to cloud platforms. Users can
employ the NoCloud data source to inject user-data and meta-data on
virtualization platforms such as VMware, Hyper-V and KVM.</p>
<p>While other methods exist, the most straightforward method for using the
NoCloud data source is creating a seed ISO and attaching it to the virtual
machine as a CD drive. The volume must be formatted as a vfat or ISO 9660
file system with the label “cidata” or “CIDATA”.</p>
<p>Create text files named user-data and meta-data. On linux-based systems,
the mkisofs utility can be used to create the seed ISO. The following
syntax will add these files to the ISO 9660 file system.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mkisofs -joliet -rock -volid &quot;cidata&quot; -output seed.iso meta-data user-data
</pre></div>
</div>
<p>The seed.iso file can be attached to the virtual machine. As an example,
the method with KVM to attach the ISO as a CD drive follows.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ virt-install -n vyos_r1 \
   --ram 4096 \
   --vcpus 2 \
   --cdrom seed.iso \
   --os-type linux \
   --os-variant debian10 \
   --network network=default \
   --graphics vnc \
   --hvm \
   --virt-type kvm \
   --disk path=/var/lib/libvirt/images/vyos_kvm.qcow2,bus=virtio \
   --import \
   --noautoconsole
</pre></div>
</div>
<p>For more information on the NoCloud data source, visit its
page <a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html">nocloud</a> in the cloud-init documentation.</p>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<p>If you encounter problems, verify that the cloud-config document contains
valid YAML. Online resources such as <a class="reference external" href="https://www.yamllint.com/">https://www.yamllint.com/</a> provide
a simple tool for validating YAML.</p>
<p>cloud-init logs to /var/log/cloud-init.log. This file can be helpful in
determining why the configuration varies from what you expect. You can fetch
the most important data filtering output for <code class="docutils literal notranslate"><span class="pre">vyos</span></code> keyword:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo grep vyos /var/log/cloud-init.log
</pre></div>
</div>
</section>
<section id="cloud-init-on-proxmox">
<h2>Cloud-init on Proxmox<a class="headerlink" href="#cloud-init-on-proxmox" title="Link to this heading"></a></h2>
<p>Before starting, please refer to cloud-init <a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/topics/network-config.html">network-config-docs</a> in order to
know how to import user and network configurations.</p>
<p>Most important keys that needs to be considered:</p>
<ul>
<li><p>VyOS configuration commands are defined in user-data file.</p></li>
<li><p>Networking configurations shouldn’t be passed in user-data file.</p></li>
<li><p>If no networking configuration is provided, then dhcp client is going to be
enabled on first interface. Bear in mind that this configuration will be
injected at an OS level, so don’t expect to find dhcp client configuration
on vyos cli. Because of this behavior, in next example lab we will disable
dhcp-client configuration on eth0.</p>
<p>Also, this lab considers:</p>
</li>
<li><p>Proxmox IP address: <strong>192.168.0.253/24</strong></p></li>
<li><p>Storaged used: volume local, which is mounted on directory <strong>/var/lib/vz</strong>,
and contains all type of content, including snippets.</p></li>
<li><p>Remove default dhcp client on first interface, and load other
configuration during first boot, using cloud-init.</p></li>
</ul>
<section id="generate-qcow-image">
<h3>Generate qcow image<a class="headerlink" href="#generate-qcow-image" title="Link to this heading"></a></h3>
<p>A VyOS qcow image with cloud-init options is needed. This can be obtained
using <a class="reference external" href="https://github.com/vyos/vyos-vm-images">vyos-vm-images</a> repo. After cloning the repo, edit the file
<strong>qemu.yml</strong> and comment the <strong>download-iso</strong> role.</p>
<p>In this lab, we are using 1.3.0 VyOS version and setting a disk of 10G.
Download VyOS .iso file and save it as <code class="docutils literal notranslate"><span class="pre">/tmp/vyos.iso</span></code>. Command used for
generating qcow image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>ansible-playbook<span class="w"> </span>qemu.yml<span class="w"> </span>-e<span class="w"> </span><span class="nv">disk_size</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-e<span class="w"> </span><span class="nv">iso_local</span><span class="o">=</span>/tmp/vyos.iso<span class="w"> </span>-e<span class="w"> </span><span class="nv">grub_console</span><span class="o">=</span>serial<span class="w"> </span>-e<span class="w"> </span><span class="nv">vyos_version</span><span class="o">=</span><span class="m">1</span>.3.0<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-e<span class="w"> </span><span class="nv">cloud_init</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">cloud_init_ds</span><span class="o">=</span>NoCloud
</pre></div>
</div>
<p>File generated with previous command:
<code class="docutils literal notranslate"><span class="pre">/tmp/vyos-1.3.0-cloud-init-10G-qemu.qcow2</span></code></p>
<p>Now, that file needs to be copied to proxmox server:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>scp<span class="w"> </span>/tmp/vyos-1.3.0-cloud-init-10G-qemu.qcow2<span class="w"> </span>root@192.168.0.253:/tmp/
</pre></div>
</div>
</section>
<section id="prepare-cloud-init-files">
<h3>Prepare cloud-init files<a class="headerlink" href="#prepare-cloud-init-files" title="Link to this heading"></a></h3>
<p>In Proxmox server three files are going to be used for this setup:</p>
<ul class="simple">
<li><p><strong>network-config</strong>: file that will indicate to avoid dhcp client on first
interface.</p></li>
<li><p><strong>user-data</strong>: includes vyos-commands.</p></li>
<li><p><strong>meta-data</strong>: empty file (required).</p></li>
</ul>
<p>In this lab, all files are located in <code class="docutils literal notranslate"><span class="pre">/tmp/</span></code>. So, before going on, lets
move to that directory:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/tmp/
</pre></div>
</div>
<p><strong>user-data</strong> file must start with <code class="docutils literal notranslate"><span class="pre">#cloud-config</span></code> and contains
vyos-commands. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#cloud-config
vyos_config_commands:
  - set system host-name &#39;vyos-BRAS&#39;
  - set service ntp server 1.pool.ntp.org
  - set service ntp server 2.pool.ntp.org
  - delete interfaces ethernet eth0 address &#39;dhcp&#39;
  - set interfaces ethernet eth0 address &#39;198.51.100.2/30&#39;
  - set interfaces ethernet eth0 description &#39;WAN - ISP01&#39;
  - set interfaces ethernet eth1 address &#39;192.168.25.1/24&#39;
  - set interfaces ethernet eth1 description &#39;Comming through VLAN 25&#39;
  - set interfaces ethernet eth2 address &#39;192.168.26.1/24&#39;
  - set interfaces ethernet eth2 description &#39;Comming through VLAN 26&#39;
  - set protocols static route 0.0.0.0/0 next-hop &#39;198.51.100.1&#39;
</pre></div>
</div>
<p><strong>network-config</strong> file only has configuration that disables the automatic
dhcp client on first interface.</p>
<p>Content of network-config file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>version: 2
ethernets:
  eth0:
    dhcp4: false
    dhcp6: false
</pre></div>
</div>
<p>Finally, file <strong>meta-data</strong> has no content, but it’s required.</p>
</section>
<section id="create-seed-iso">
<h3>Create seed.iso<a class="headerlink" href="#create-seed-iso" title="Link to this heading"></a></h3>
<p>Once the three files were created, it’s time to generate the <code class="docutils literal notranslate"><span class="pre">seed.iso</span></code>
image, which needs to be mounted to the new VM as a cd.</p>
<p>Command for generating <code class="docutils literal notranslate"><span class="pre">seed.iso</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkisofs<span class="w"> </span>-joliet<span class="w"> </span>-rock<span class="w"> </span>-volid<span class="w"> </span><span class="s2">&quot;cidata&quot;</span><span class="w"> </span>-output<span class="w"> </span>seed.iso<span class="w"> </span>meta-data<span class="w"> </span><span class="se">\</span>
user-data<span class="w"> </span>network-config
</pre></div>
</div>
<p><strong>NOTE</strong>: be careful while copying and pasting previous commands. Double
quotes may need to be corrected.</p>
</section>
<section id="creating-the-vm">
<h3>Creating the VM<a class="headerlink" href="#creating-the-vm" title="Link to this heading"></a></h3>
<p>Notes for this particular example, that may need to be modified in other
setups:</p>
<ul class="simple">
<li><p>VM ID: in this example, VM ID used is 555.</p></li>
<li><p>VM Storage: <code class="docutils literal notranslate"><span class="pre">local</span></code> volume is used.</p></li>
<li><p>ISO files storage: <code class="docutils literal notranslate"><span class="pre">local</span></code> volume is used for <code class="docutils literal notranslate"><span class="pre">.iso</span></code> file storage. In
this scenario <code class="docutils literal notranslate"><span class="pre">local</span></code> volume type is set to <strong>directory</strong>, abd attached to
<code class="docutils literal notranslate"><span class="pre">/var/lib/vz</span></code>.</p></li>
<li><p>VM Resources: these parameters can be modified as needed.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">seed.iso</span></code> was previously created in directory <code class="docutils literal notranslate"><span class="pre">/tmp/</span></code>. It’s necessary to
move it to <code class="docutils literal notranslate"><span class="pre">/var/lib/vz/template/iso</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mv<span class="w"> </span>/tmp/seed.iso<span class="w"> </span>/var/lib/vz/template/iso/
</pre></div>
</div>
<p>On proxmox server:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>## Create VM, import disk and define boot order
qm create 555 --name vyos-1.3.0-cloudinit --memory 1024 --net0 virtio,bridge=vmbr0
qm importdisk 555 vyos-1.3.0-cloud-init-10G-qemu.qcow2 local
qm set 555 --virtio0 local:555/vm-555-disk-0.raw
qm set 555 --boot order=virtio0

## Import seed.iso for cloud init
qm set 555 --ide2 media=cdrom,file=local:iso/seed.iso

## Since this server has 1 nic, lets add network intefaces (vlan 25 and 26)
qm set 555 --net1 virtio,bridge=vmbr0,firewall=1,tag=25
qm set 555 --net2 virtio,bridge=vmbr0,firewall=1,tag=26
</pre></div>
</div>
</section>
<section id="power-on-vm-and-verifications">
<h3>Power on VM and verifications<a class="headerlink" href="#power-on-vm-and-verifications" title="Link to this heading"></a></h3>
<p>From cli or GUI, power on VM, and after it boots, verify configuration</p>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>VyOS <a class="reference external" href="https://docs.vyos.io/en/equuleus/automation/cloud-init.html?highlight=cloud-init#vyos-cloud-init">cloud-init-docs</a>.</p></li>
<li><p>Cloud-init <a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/topics/network-config.html">network-config-docs</a>.</p></li>
<li><p>Proxmox <a class="reference external" href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html#qm_cloud_init">Cloud-init-Support</a>.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="command-scripting.html" class="btn btn-neutral float-left" title="Command Scripting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vyos-pyvyos.html" class="btn btn-neutral float-right" title="pyvyos" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2024, VyOS maintainers and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>