

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploying VyOS in the Google Cloud &mdash; VyOS 1.5.x (circinus) documentation</title>
      <link rel="stylesheet" type="text/css" href="../../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../static/vyos-logo-icon.png"/>
      <script src="../../static/jquery.js?v=5d32c60e"></script>
      <script src="../../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../static/documentation_options.js?v=719443cf"></script>
      <script src="../../static/doctools.js?v=9bcbadda"></script>
      <script src="../../static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../static/design-tabs.js?v=f930bc37"></script>
    <script src="../../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Napalm" href="../vyos-napalm.html" />
    <link rel="prev" title="Deploying VyOS in the vSphere infrastructure" href="terraformvSphere.html" />
    <style>#vyos-header-iframe{position:fixed;top:0;left:0;right:0;z-index:999999999;width:100%;border:none}</style>
    <style>#vyos-footer-iframe{width:100%;border:none}</style>
    <link href="../../static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/lists.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/hints.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/headers.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/breadcrumbs.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/linkButtons.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/text.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/leftSidebar.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/scrolls.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/tables.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/installation/running-on-bare-metal.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/code-snippets.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/separate-commands.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/configuration/index.css" rel="stylesheet" type="text/css">
    <link href="../../static/css/datatables.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="../../static/js/datatables.js"></script>
    <script type="text/javascript" charset="utf8" src="../../static/js/tables.js"></script>
    <script type="text/javascript" charset="utf8" src="../../static/js/codecopier.js"></script>
    <script type="text/javascript" charset="utf8" src="../../static/js/sidebar.js"></script>
    <script type="text/javascript" charset="utf8" src="../../static/js/footer.js"></script>
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VyOS
              <img src="../../static/vyos-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introducing/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introducing/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation and Image Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html#configuration-overview">Configuration Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adminguide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operation/index.html">Operation Mode</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">VyOS Automation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../vyos-api.html">VyOS API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-ansible.html">Ansible</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">VyOS Terraform</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="terraformvyos.html">Terraform for VyOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="terraformAWS.html">Deploying VyOS in the AWS cloud</a></li>
<li class="toctree-l3"><a class="reference internal" href="terraformAZ.html">Deploying VyOS in the Azure cloud</a></li>
<li class="toctree-l3"><a class="reference internal" href="terraformvSphere.html">Deploying VyOS in the vSphere infrastructure</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Deploying VyOS in the Google Cloud</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preparation-steps-for-deploying-vyos-on-google">Preparation steps for deploying VyOS on Google</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-creating-a-google-cloud-instance-and-check-the-result">Start creating a Google Cloud instance and check the result.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#structure-of-files-terrafom-for-google-cloud">Structure of files Terrafom for Google Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="#file-contents-of-terrafom-for-google-cloud">File contents of Terrafom for Google Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="#structure-of-files-ansible-for-google-cloud">Structure of files Ansible for Google Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="#file-contents-of-ansible-for-google-cloud">File contents of Ansible for Google Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sourse-files-for-google-cloud-from-git">Sourse files for Google Cloud from GIT</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-napalm.html">Napalm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-netmiko.html">Netmiko</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-salt.html">Salt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../command-scripting.html">Command Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud-init.html">VyOS cloud-init</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-pyvyos.html">pyvyos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vyos-govyos.html">go-vyos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configexamples/index.html">Configuration Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configexamples/index.html#configuration-blueprints-autotest">Configuration Blueprints (autotest)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/build-vyos.html">Build VyOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/issues-features.html">Issues/Feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/upstream-packages.html">Upstream packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">Write Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VyOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">VyOS Automation</a></li>
          <li class="breadcrumb-item"><a href="index.html">VyOS Terraform</a></li>
      <li class="breadcrumb-item active">Deploying VyOS in the Google Cloud</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../sources/automation/terraform/terraformGoogle.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploying-vyos-in-the-google-cloud">
<span id="terraformgoogle"></span><h1>Deploying VyOS in the Google Cloud<a class="headerlink" href="#deploying-vyos-in-the-google-cloud" title="Link to this heading"></a></h1>
<p>With the help of Terraform, you can quickly deploy VyOS-based infrastructure in the Google Cloud. If necessary, the infrastructure can be removed using terraform.
Also we will make provisioning using Ansible.</p>
<p>In this case, we’ll create the necessary files for Terraform and Ansible. Next, using Terraform, we’ll create a single instance on the Google Cloud and make provisioning using Ansible.</p>
<section id="preparation-steps-for-deploying-vyos-on-google">
<h2>Preparation steps for deploying VyOS on Google<a class="headerlink" href="#preparation-steps-for-deploying-vyos-on-google" title="Link to this heading"></a></h2>
<p>How to create a single instance and install your configuration using Terraform+Ansible+Google
Step by step:</p>
<p>Google Cloud</p>
<p>1 Create an account with Google Cloud and a new project</p>
<a class="reference internal image-reference" href="../../images/project.png"><img alt="Network Topology Diagram" class="align-center" src="../../images/project.png" style="width: 50%;" />
</a>
<p>2 Create a service aacount and download your key (.JSON)</p>
<a class="reference internal image-reference" href="../../images/service.png"><img alt="Network Topology Diagram" class="align-center" src="../../images/service.png" style="width: 50%;" />
</a>
<a class="reference internal image-reference" href="../../images/key.png"><img alt="Network Topology Diagram" class="align-center" src="../../images/key.png" style="width: 50%;" />
</a>
<p>The .JSON file download automaticly after creating and will look like:</p>
<a class="reference internal image-reference" href="../../images/json.png"><img alt="Network Topology Diagram" class="align-center" src="../../images/json.png" style="width: 50%;" />
</a>
<p>Terraform</p>
<p>1 Create an UNIX or Windows instance</p>
<p>2 Download and install Terraform</p>
<p>3 Create the folder for example /root/google</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mkdir /root/google
</pre></div>
</div>
<p>4 Copy all files into your Terraform project “/root/google” (vyos.tf, var.tf, terraform.tfvars, .JSON), more detailed see <a class="reference internal" href="#structure-of-files-terrafom-for-google-cloud">Structure of files Terrafom for google cloud</a></p>
<p>5 Type the commands :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /&lt;your folder&gt;
terraform init
</pre></div>
</div>
<p>Ansible</p>
<p>1 Create an UNIX instance whenever you want (local, cloud, and so on)</p>
<p>2 Download and install Ansible</p>
<p>3 Create the folder for example /root/google/</p>
<p>4 Copy all files into your Ansible project “/root/google/” (ansible.cfg, instance.yml, mykey.json and “all”), more detailed see <a class="reference internal" href="#structure-of-files-ansible-for-google-cloud">Structure of files Ansible for Google Cloud</a></p>
<p>mykey.json you have to get using step 2 of the Google Cloud</p>
<p>Start</p>
<p>Type the commands on your Terraform instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /&lt;your folder&gt;
terraform plan
terraform apply
yes
</pre></div>
</div>
</section>
<section id="start-creating-a-google-cloud-instance-and-check-the-result">
<h2>Start creating a Google Cloud instance and check the result.<a class="headerlink" href="#start-creating-a-google-cloud-instance-and-check-the-result" title="Link to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># terraform apply

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # google_compute_firewall.tcp_22[0] will be created
  + resource &quot;google_compute_firewall&quot; &quot;tcp_22&quot; {
      + creation_timestamp = (known after apply)
      + destination_ranges = (known after apply)
      + direction          = (known after apply)
      + enable_logging     = (known after apply)
      + id                 = (known after apply)
      + name               = &quot;vyos-tcp-22&quot;
      + network            = &quot;default&quot;
      + priority           = 1000
      + project            = &quot;vyosproject&quot;
      + self_link          = (known after apply)
      + source_ranges      = [
          + &quot;0.0.0.0/0&quot;,
        ]
      + target_tags        = [
          + &quot;vyos-deployment&quot;,
        ]

      + allow {
          + ports    = [
              + &quot;22&quot;,
            ]
          + protocol = &quot;tcp&quot;
        }
    }

  # google_compute_firewall.udp_500_4500[0] will be created
  + resource &quot;google_compute_firewall&quot; &quot;udp_500_4500&quot; {
      + creation_timestamp = (known after apply)
      + destination_ranges = (known after apply)
      + direction          = (known after apply)
      + enable_logging     = (known after apply)
      + id                 = (known after apply)
     + name               = &quot;vyos-udp-500-4500&quot;
      + network            = &quot;default&quot;
      + priority           = 1000
      + project            = &quot;vyosproject&quot;
      + self_link          = (known after apply)
      + source_ranges      = [
         + &quot;0.0.0.0/0&quot;,
        ]
      + target_tags        = [
          + &quot;vyos-deployment&quot;,
        ]

      + allow {
          + ports    = [
              + &quot;500&quot;,
              + &quot;4500&quot;,
            ]
          + protocol = &quot;udp&quot;
        }
    }

  # google_compute_instance.default will be created
  + resource &quot;google_compute_instance&quot; &quot;default&quot; {
      + can_ip_forward       = true
      + cpu_platform         = (known after apply)
      + current_status       = (known after apply)
      + deletion_protection  = false
      + effective_labels     = (known after apply)
      + guest_accelerator    = (known after apply)
      + id                   = (known after apply)
      + instance_id          = (known after apply)
      + label_fingerprint    = (known after apply)
      + machine_type         = &quot;n2-highcpu-4&quot;
      + metadata             = {
          + &quot;enable-oslogin&quot;     = &quot;FALSE&quot;
          + &quot;serial-port-enable&quot; = &quot;TRUE&quot;
          + &quot;user-data&quot;          = &quot;&quot;
        }
      + metadata_fingerprint = (known after apply)
      + min_cpu_platform     = (known after apply)
      + name                 = &quot;vyos&quot;
      + project              = &quot;vyosproject&quot;
      + self_link            = (known after apply)
      + tags_fingerprint     = (known after apply)
      + terraform_labels     = (known after apply)
      + zone                 = &quot;us-west1-a&quot;

      + boot_disk {
          + auto_delete                = true
          + device_name                = (known after apply)
          + disk_encryption_key_sha256 = (known after apply)
          + kms_key_self_link          = (known after apply)
          + mode                       = &quot;READ_WRITE&quot;
          + source                     = (known after apply)

          + initialize_params {
              + image                  = &quot;projects/sentrium-public/global/images/vyos-1-3-5-20231222143039&quot;
              + labels                 = (known after apply)
              + provisioned_iops       = (known after apply)
              + provisioned_throughput = (known after apply)
              + size                   = (known after apply)
              + type                   = (known after apply)
            }
        }

      + network_interface {
          + internal_ipv6_prefix_length = (known after apply)
          + ipv6_access_type            = (known after apply)
          + ipv6_address                = (known after apply)
          + name                        = (known after apply)
          + network                     = &quot;default&quot;
          + network_ip                  = (known after apply)
          + nic_type                    = &quot;GVNIC&quot;
          + stack_type                  = (known after apply)
          + subnetwork                  = &quot;default&quot;
          + subnetwork_project          = (known after apply)

          + access_config {
              + nat_ip       = (known after apply)
              + network_tier = (known after apply)
            }
        }
    }

  # local_file.ip will be created
  + resource &quot;local_file&quot; &quot;ip&quot; {
      + content              = (known after apply)
      + content_base64sha256 = (known after apply)
      + content_base64sha512 = (known after apply)
      + content_md5          = (known after apply)
      + content_sha1         = (known after apply)
      + content_sha256       = (known after apply)
      + content_sha512       = (known after apply)
      + directory_permission = &quot;0777&quot;
      + file_permission      = &quot;0777&quot;
      + filename             = &quot;ip.txt&quot;
      + id                   = (known after apply)
    }

  # null_resource.SSHconnection1 will be created
  + resource &quot;null_resource&quot; &quot;SSHconnection1&quot; {
      + id = (known after apply)
    }

  # null_resource.SSHconnection2 will be created
  + resource &quot;null_resource&quot; &quot;SSHconnection2&quot; {
      + id = (known after apply)
    }

Plan: 6 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + public_ip_address = (known after apply)
╷
│ Warning: Quoted references are deprecated
│
│   on vyos.tf line 126, in resource &quot;null_resource&quot; &quot;SSHconnection1&quot;:
│  126:   depends_on = [&quot;google_compute_instance.default&quot;]
│
│ In this context, references are expected literally rather than in quotes. Terraform 0.11 and earlier required quotes, but quoted references are now deprecated and will be removed in a
│ future version of Terraform. Remove the quotes surrounding this reference to silence this warning.
│
│ (and one more similar warning elsewhere)
╵

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

google_compute_firewall.udp_500_4500[0]: Creating...
google_compute_firewall.tcp_22[0]: Creating...
google_compute_instance.default: Creating...
google_compute_firewall.udp_500_4500[0]: Still creating... [10s elapsed]
google_compute_firewall.tcp_22[0]: Still creating... [10s elapsed]
google_compute_instance.default: Still creating... [10s elapsed]
google_compute_firewall.tcp_22[0]: Creation complete after 16s [id=projects/vyosproject/global/firewalls/vyos-tcp-22]
google_compute_firewall.udp_500_4500[0]: Creation complete after 16s [id=projects/vyosproject/global/firewalls/vyos-udp-500-4500]
google_compute_instance.default: Creation complete after 20s [id=projects/vyosproject/zones/us-west1-a/instances/vyos]
null_resource.SSHconnection1: Creating...
null_resource.SSHconnection2: Creating...
null_resource.SSHconnection1: Provisioning with &#39;file&#39;...
null_resource.SSHconnection2: Provisioning with &#39;remote-exec&#39;...
null_resource.SSHconnection2 (remote-exec): Connecting to remote host via SSH...
null_resource.SSHconnection2 (remote-exec):   Host: 10.***.***.104
null_resource.SSHconnection2 (remote-exec):   User: root
null_resource.SSHconnection2 (remote-exec):   Password: true
null_resource.SSHconnection2 (remote-exec):   Private key: false
null_resource.SSHconnection2 (remote-exec):   Certificate: false
null_resource.SSHconnection2 (remote-exec):   SSH Agent: false
null_resource.SSHconnection2 (remote-exec):   Checking Host Key: false
null_resource.SSHconnection2 (remote-exec):   Target Platform: unix
local_file.ip: Creating...
local_file.ip: Creation complete after 0s [id=7d568c3b994a018c942a3cdb952ccbf3c729d0ca]
null_resource.SSHconnection2 (remote-exec): Connected!
null_resource.SSHconnection1: Creation complete after 4s [id=5175298735911137161]

null_resource.SSHconnection2 (remote-exec): PLAY [integration of terraform and ansible] ************************************

null_resource.SSHconnection2 (remote-exec): TASK [Wait 300 seconds, but only start checking after 60 seconds] **************
null_resource.SSHconnection2: Still creating... [10s elapsed]
null_resource.SSHconnection2: Still creating... [20s elapsed]
null_resource.SSHconnection2: Still creating... [30s elapsed]
null_resource.SSHconnection2: Still creating... [40s elapsed]
null_resource.SSHconnection2: Still creating... [50s elapsed]
null_resource.SSHconnection2: Still creating... [1m0s elapsed]
null_resource.SSHconnection2: Still creating... [1m10s elapsed]
null_resource.SSHconnection2 (remote-exec): ok: [104.***.***.158]

null_resource.SSHconnection2 (remote-exec): TASK [Configure general settings for the vyos hosts group] *********************
null_resource.SSHconnection2: Still creating... [1m20s elapsed]
null_resource.SSHconnection2 (remote-exec): changed: [104.***.***.158]

null_resource.SSHconnection2 (remote-exec): PLAY RECAP *********************************************************************
null_resource.SSHconnection2 (remote-exec): 104.***.***.158            : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.SSHconnection2: Creation complete after 1m22s [id=3355727070503709742]

Apply complete! Resources: 6 added, 0 changed, 0 destroyed.

Outputs:

public_ip_address = &quot;104.***.***.158&quot;
</pre></div>
</div>
<p>After executing all the commands, you will have your VyOS instance on the Google Cloud with your configuration; it’s a very convenient decision.
If you need to delete the instance, please type the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>terraform destroy
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<p>1 Increase the time in the file instance.yml from 300 sec to 500 sec or more. (It depends on your location).
Make sure that you have opened access to the instance in the security group.</p>
<p>2 Terraform doesn’t connect via SSH to your Ansible instance: you have to check the correct login and password in the part of the file VyOS.tf</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>connection {
 type     = &quot;ssh&quot;
 user     = &quot;root&quot;              # open root access using login and password on your Ansible
 password = var.password        # check password in the file terraform.tfvars isn&#39;t empty
     host = var.host            # check the correct IP address of your Ansible host
}
</pre></div>
</div>
<p>Make sure that Ansible is pinging from Terrafom.</p>
</section>
<section id="structure-of-files-terrafom-for-google-cloud">
<h2>Structure of files Terrafom for Google Cloud<a class="headerlink" href="#structure-of-files-terrafom-for-google-cloud" title="Link to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.
├── vyos.tf                            # The main script
├── ***.JSON               # The credential file from Google Cloud
├── var.tf                                     # The file of all variables in &quot;vyos.tf&quot;
└── terraform.tfvars           # The value of all variables (passwords, login, IP addresses and so on)
</pre></div>
</div>
</section>
<section id="file-contents-of-terrafom-for-google-cloud">
<h2>File contents of Terrafom for Google Cloud<a class="headerlink" href="#file-contents-of-terrafom-for-google-cloud" title="Link to this heading"></a></h2>
<p>vyos.tf</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##############################################################################
# Build a VyOS VM from the Marketplace
#
# After deploying the GCP instance and getting an IP address, the IP address is copied into the file
#&quot;ip.txt&quot; and copied to the Ansible node for provisioning.
##############################################################################

terraform {
  required_providers {
    google = {
      source = &quot;hashicorp/google&quot;
    }
  }
}

provider &quot;google&quot; {
  project         = var.project_id
  request_timeout = &quot;60s&quot;
  credentials = file(var.gcp_auth_file)
}

locals {
  network_interfaces = [for i, n in var.networks : {
    network     = n,
    subnetwork  = length(var.sub_networks) &gt; i ? element(var.sub_networks, i) : null
    external_ip = length(var.external_ips) &gt; i ? element(var.external_ips, i) : &quot;NONE&quot;
    }
  ]
}

resource &quot;google_compute_instance&quot; &quot;default&quot; {
  name         = var.goog_cm_deployment_name
  machine_type = var.machine_type
  zone         = var.zone

  metadata = {
    enable-oslogin     = &quot;FALSE&quot;
    serial-port-enable = &quot;TRUE&quot;
    user-data          = var.vyos_user_data
  }
  boot_disk {
    initialize_params {
      image = var.image
    }
  }

  can_ip_forward = true

  dynamic &quot;network_interface&quot; {
    for_each = local.network_interfaces
    content {
      network    = network_interface.value.network
      subnetwork = network_interface.value.subnetwork
      nic_type   = &quot;GVNIC&quot;
      dynamic &quot;access_config&quot; {
        for_each = network_interface.value.external_ip == &quot;NONE&quot; ? [] : [1]
        content {
          nat_ip = network_interface.value.external_ip == &quot;EPHEMERAL&quot; ? null : network_interface.value.external_ip
        }
      }
    }
  }
}

resource &quot;google_compute_firewall&quot; &quot;tcp_22&quot; {
  count = var.enable_tcp_22 ? 1 : 0

  name    = &quot;${var.goog_cm_deployment_name}-tcp-22&quot;
  network = element(var.networks, 0)

  allow {
    ports    = [&quot;22&quot;]
    protocol = &quot;tcp&quot;
  }

  source_ranges = [&quot;0.0.0.0/0&quot;]

  target_tags = [&quot;${var.goog_cm_deployment_name}-deployment&quot;]
}

resource &quot;google_compute_firewall&quot; &quot;udp_500_4500&quot; {
  count = var.enable_udp_500_4500 ? 1 : 0

  name    = &quot;${var.goog_cm_deployment_name}-udp-500-4500&quot;
  network = element(var.networks, 0)

allow {
  ports    = [&quot;500&quot;, &quot;4500&quot;]
  protocol = &quot;udp&quot;
}

source_ranges = [&quot;0.0.0.0/0&quot;]

  target_tags = [&quot;${var.goog_cm_deployment_name}-deployment&quot;]
}

output &quot;public_ip_address&quot; {
  value = google_compute_instance.default.network_interface[0].access_config[0].nat_ip
}

##############################################################################
#
# IP of google instance copied to a file ip.txt in local system Terraform
# ip.txt looks like:
# cat ./ip.txt
# ххх.ххх.ххх.ххх
##############################################################################

resource &quot;local_file&quot; &quot;ip&quot; {
    content  = google_compute_instance.default.network_interface[0].access_config[0].nat_ip
    filename = &quot;ip.txt&quot;
}

#connecting to the Ansible control node using SSH connection

##############################################################################
# Steps &quot;SSHconnection1&quot; and &quot;SSHconnection2&quot; need to get file ip.txt from the terraform node and start remotely the playbook of Ansible.
##############################################################################

resource &quot;null_resource&quot; &quot;SSHconnection1&quot; {
depends_on = [&quot;google_compute_instance.default&quot;]
connection {
   type     = &quot;ssh&quot;
   user     = &quot;root&quot;
   password = var.password
   host     = var.host
}

#copying the ip.txt file to the Ansible control node from local system

 provisioner &quot;file&quot; {
    source      = &quot;ip.txt&quot;
    destination = &quot;/root/google/ip.txt&quot;                             # The folder of your Ansible project
       }
}

resource &quot;null_resource&quot; &quot;SSHconnection2&quot; {
depends_on = [&quot;google_compute_instance.default&quot;]
connection {
    type     = &quot;ssh&quot;
    user     = &quot;root&quot;
        password = var.password
    host     = var.host
}

#command to run Ansible playbook on remote Linux OS

provisioner &quot;remote-exec&quot; {
    inline = [
    &quot;cd /root/google/&quot;,
    &quot;ansible-playbook instance.yml&quot;                               # more detailed in &quot;File contents of Ansible for Google Cloud&quot;
]
}
}
</pre></div>
</div>
<p>var.tf</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>variable &quot;image&quot; {
  type    = string
  default = &quot;projects/sentrium-public/global/images/vyos-1-3-5-20231222143039&quot;
}

variable &quot;project_id&quot; {
  type = string
}

variable &quot;zone&quot; {
  type = string
}

##############################################################################
# You can choose more chipper type than n2-highcpu-4
##############################################################################

variable &quot;machine_type&quot; {
  type    = string
  default = &quot;n2-highcpu-4&quot;
}

variable &quot;networks&quot; {
  description = &quot;The network name to attach the VM instance.&quot;
  type        = list(string)
  default     = [&quot;default&quot;]
}

variable &quot;sub_networks&quot; {
  description = &quot;The sub network name to attach the VM instance.&quot;
  type        = list(string)
  default     = [&quot;default&quot;]
}

variable &quot;external_ips&quot; {
  description = &quot;The external IPs assigned to the VM for public access.&quot;
  type        = list(string)
  default     = [&quot;EPHEMERAL&quot;]
}

variable &quot;enable_tcp_22&quot; {
  description = &quot;Allow SSH traffic from the Internet&quot;
  type        = bool
  default     = true
}

variable &quot;enable_udp_500_4500&quot; {
  description = &quot;Allow IKE/IPSec traffic from the Internet&quot;
  type        = bool
  default     = true
}

variable &quot;vyos_user_data&quot; {
  type    = string
  default = &quot;&quot;
}

// Marketplace requires this variable name to be declared
variable &quot;goog_cm_deployment_name&quot; {
  description = &quot;VyOS Universal Router Deployment&quot;
  type        = string
  default     = &quot;vyos&quot;
}

# GCP authentication file
variable &quot;gcp_auth_file&quot; {
  type        = string
  description = &quot;GCP authentication file&quot;
}

variable &quot;password&quot; {
   description = &quot;pass for Ansible&quot;
   type = string
   sensitive = true
}
variable &quot;host&quot;{
  description = &quot;The IP of my Ansible&quot;
  type = string
}
</pre></div>
</div>
<p>terraform.tfvars</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##############################################################################
# Must be filled in
##############################################################################

zone = &quot;us-west1-a&quot;
gcp_auth_file = &quot;/root/***/***.json&quot;   # path of your .json file
project_id    = &quot;&quot;                     # the google project
password      = &quot;&quot;                     # password for Ansible SSH
host          = &quot;&quot;                     # IP of my Ansible
</pre></div>
</div>
</section>
<section id="structure-of-files-ansible-for-google-cloud">
<h2>Structure of files Ansible for Google Cloud<a class="headerlink" href="#structure-of-files-ansible-for-google-cloud" title="Link to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.
├── group_vars
    └── all
├── ansible.cfg
└── instance.yml
</pre></div>
</div>
</section>
<section id="file-contents-of-ansible-for-google-cloud">
<h2>File contents of Ansible for Google Cloud<a class="headerlink" href="#file-contents-of-ansible-for-google-cloud" title="Link to this heading"></a></h2>
<p>ansible.cfg</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[defaults]
inventory = /root/google/ip.txt
host_key_checking= False
remote_user=vyos
</pre></div>
</div>
<p>instance.yml</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>##############################################################################
# About tasks:
# &quot;Wait 300 seconds, but only start checking after 60 seconds&quot; - try to make ssh connection every 60 seconds until 300 seconds
# &quot;Configure general settings for the VyOS hosts group&quot; - make provisioning into Google Cloud VyOS node
# You have to add all necessary cammans of VyOS under the block &quot;lines:&quot;
##############################################################################


- name: integration of terraform and ansible
  hosts: all
  gather_facts: &#39;no&#39;

  tasks:

    - name: &quot;Wait 300 seconds, but only start checking after 60 seconds&quot;
      wait_for_connection:
        delay: 60
        timeout: 300

    - name: &quot;Configure general settings for the VyOS hosts group&quot;
      vyos_config:
        lines:
          - set system name-server xxx.xxx.xxx.xxx
        save:
          true
</pre></div>
</div>
<p>group_vars/all</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ansible_connection: ansible.netcommon.network_cli
ansible_network_os: vyos.vyos.vyos
ansible_user: vyos
ansible_ssh_pass: vyos
</pre></div>
</div>
</section>
<section id="sourse-files-for-google-cloud-from-git">
<h2>Sourse files for Google Cloud from GIT<a class="headerlink" href="#sourse-files-for-google-cloud-from-git" title="Link to this heading"></a></h2>
<p>All files about the article can be found <a class="reference external" href="https://github.com/vyos/vyos-automation/tree/main/TerraformCloud/Google_terraform_ansible_single_vyos_instance-main">here</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="terraformvSphere.html" class="btn btn-neutral float-left" title="Deploying VyOS in the vSphere infrastructure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../vyos-napalm.html" class="btn btn-neutral float-right" title="Napalm" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2024, VyOS maintainers and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <head>
      <style>
          #branch-select-container {
              position: fixed;
              bottom: 10px;
              right: 10px;
              background-color: #f0f0f0;
              padding: 5px;
              border: 1px solid #ccc;
              border-radius: 5px;
          }
      </style>
  </head>
  <body>
      <div id="branch-select-container">
          <select id="branch-select">
              <option value="sagitta">Sagitta</option>
              <option value="circinus">Circinus</option>
          </select>
      </div>
      <script>
          // Define the branches
          const branches = ['sagitta', 'circinus'];
  
          // Get the current branch name from the URL
          const currentUrl = window.location.href;
          const currentBranch = branches.find(branch => currentUrl.includes(branch));
  
          // Set the selected option in the dropdown
          const branchSelect = document.getElementById('branch-select');
          branchSelect.value = currentBranch;
  
          // Add an event listener to the dropdown
          branchSelect.addEventListener('change', () => {
              const newBranch = branchSelect.value;
              const newUrl = currentUrl.replace(currentBranch, newBranch);
              window.location.href = newUrl;
          });
      </script>
  </body>


</body>
</html>