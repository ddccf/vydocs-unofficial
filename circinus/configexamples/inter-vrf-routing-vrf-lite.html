

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inter-VRF Routing over VRF Lite &mdash; VyOS 1.5.x (circinus) documentation</title>
      <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../static/vyos-logo-icon.png"/>
      <script src="../static/jquery.js?v=5d32c60e"></script>
      <script src="../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../static/documentation_options.js?v=719443cf"></script>
      <script src="../static/doctools.js?v=9bcbadda"></script>
      <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../static/design-tabs.js?v=f930bc37"></script>
    <script src="../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="QoS example" href="qos.html" />
    <link rel="prev" title="PPPoE over L2TP" href="lac-lns.html" />
    <style>#vyos-header-iframe{position:fixed;top:0;left:0;right:0;z-index:999999999;width:100%;border:none}</style>
    <style>#vyos-footer-iframe{width:100%;border:none}</style>
    <link href="../static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="../static/css/lists.css" rel="stylesheet" type="text/css">
    <link href="../static/css/hints.css" rel="stylesheet" type="text/css">
    <link href="../static/css/headers.css" rel="stylesheet" type="text/css">
    <link href="../static/css/breadcrumbs.css" rel="stylesheet" type="text/css">
    <link href="../static/css/linkButtons.css" rel="stylesheet" type="text/css">
    <link href="../static/css/text.css" rel="stylesheet" type="text/css">
    <link href="../static/css/leftSidebar.css" rel="stylesheet" type="text/css">
    <link href="../static/css/scrolls.css" rel="stylesheet" type="text/css">
    <link href="../static/css/tables.css" rel="stylesheet" type="text/css">
    <link href="../static/css/installation/running-on-bare-metal.css" rel="stylesheet" type="text/css">
    <link href="../static/css/code-snippets.css" rel="stylesheet" type="text/css">
    <link href="../static/css/separate-commands.css" rel="stylesheet" type="text/css">
    <link href="../static/css/configuration/index.css" rel="stylesheet" type="text/css">
    <link href="../static/css/datatables.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="../static/js/datatables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/tables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/codecopier.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/sidebar.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/footer.js"></script>
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VyOS
              <img src="../static/vyos-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introducing/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introducing/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation and Image Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html#configuration-overview">Configuration Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adminguide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/index.html">Operation Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../automation/index.html">VyOS Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Configuration Blueprints</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="firewall.html">Firewall Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="bgp-ipv6-unnumbered.html">BGP IPv6 unnumbered with extended nexthop</a></li>
<li class="toctree-l2"><a class="reference internal" href="ospf-unnumbered.html">OSPF unnumbered with ECMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure-vpn-bgp.html">Route-Based Site-to-Site VPN to Azure (BGP over IKEv2/IPsec)</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure-vpn-dual-bgp.html">Route-Based Redundant Site-to-Site VPN to Azure (BGP over IKEv2/IPsec)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ha.html">High Availability Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="wan-load-balancing.html">WAN Load Balancer examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="pppoe-ipv6-basic.html">PPPoE IPv6 Basic Setup for Home Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3vpn-hub-and-spoke.html">L3VPN for Hub-and-Spoke connectivity with VyOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="lac-lns.html">PPPoE over L2TP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Inter-VRF Routing over VRF Lite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#topology">Topology</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ip-schema">IP Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rd-rt-schema">RD &amp; RT Schema</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configurations">Configurations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remote-networks">Remote Networks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#core-router">Core Router</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#conclusions">Conclusions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-a">Appendix-A</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#full-configuration-from-all-devices">Full configuration from all devices</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-b">Appendix-B</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#route-filtering">Route-Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="qos.html">QoS example</a></li>
<li class="toctree-l2"><a class="reference internal" href="segment-routing-isis.html">Segment-routing IS-IS example</a></li>
<li class="toctree-l2"><a class="reference internal" href="nmp.html">NMP example</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible.html">Ansible example</a></li>
<li class="toctree-l2"><a class="reference internal" href="policy-based-ipsec-and-firewall.html">Policy-Based Site-to-Site VPN and Firewall Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="site-2-site-cisco.html">Site-to-Site IPSec VPN to Cisco using FlexVPN</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#configuration-blueprints-autotest">Configuration Blueprints (autotest)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/build-vyos.html">Build VyOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/issues-features.html">Issues/Feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/upstream-packages.html">Upstream packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Write Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VyOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Configuration Blueprints</a></li>
      <li class="breadcrumb-item active">Inter-VRF Routing over VRF Lite</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../sources/configexamples/inter-vrf-routing-vrf-lite.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="inter-vrf-routing-over-vrf-lite">
<h1>Inter-VRF Routing over VRF Lite<a class="headerlink" href="#inter-vrf-routing-over-vrf-lite" title="Link to this heading"></a></h1>
<p><strong>Virtual Routing and Forwarding</strong> is a technology that allow multiple instance
of a routing table to exist within a single device. One of the key aspect of
<strong>VRFs</strong> is that do not share the same routes or interfaces, therefore packets
are forwarded between interfaces that belong to the same VRF only.</p>
<p>Any information related to a VRF is not exchanged between devices -or in the
same device- by default, this is a technique called <strong>VRF-Lite</strong>.</p>
<p>Keep networks isolated is -in general- a good principle, but there are cases
where you might need that some network can access other in a different VRF.</p>
<p>The scope of this document is to cover such cases in a dynamic way without the
use of MPLS-LDP.</p>
<p>General information about L3VPNs can be found in the <a class="reference internal" href="../configuration/vrf/index.html#l3vpn-vrfs"><span class="std std-ref">L3VPN VRFs</span></a> chapter.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Let’s say we have a requirement to have multiple networks.</p>
<ul class="simple">
<li><p>LAN 1</p></li>
<li><p>LAN 2</p></li>
<li><p>Management</p></li>
<li><p>Internet</p></li>
</ul>
<p>Both LANs have to be able to route between each other, both will have managed
devices through a dedicated management network and both will need Internet
access yet the LAN2 will need access to some set of outside networks, not all.
The management network will need access to both LANs but cannot have access
to/from the outside.</p>
<p>This scenario could be a nightmare applying regular routing and might need
filtering in multiple interfaces.</p>
<p>A simple solution could be using different routing tables, or VRFs
for all the networks so we can keep the routing restrictions.
But for us to route between the different VRFs we would need a cable or a
logical connection between each other:</p>
<ul class="simple">
<li><p>One cable/logical connection between LAN1 and LAN2</p></li>
<li><p>One cable/logical connection between LAN1 and Internet</p></li>
<li><p>One cable/logical connection between LAN2 and Internet</p></li>
<li><p>One cable/logical connection between LAN1 and Management</p></li>
<li><p>One cable/logical connection between LAN2 and Management</p></li>
</ul>
<p>As we can see this is unpractical.</p>
<p>To address this scenario we will use to our advantage an extension of the BGP
routing protocol that will help us in the “Export” between VRFs without the
need for MPLS.</p>
<p>MP-BGP or MultiProtocol BGP introduces two main concepts to solve this
limitation:
- Route Distinguisher (RD): Is used to distinguish between different VRFs
–called VPNs- inside the BGP Process. The RD is appended to each IPv4 Network
that is advertised into BGP for that VPN making it a unique VPNv4 route.
- Route Target (RT): This is an extended BGP community append to the VPNv4 route
in the Import/Export process. When a route passes from the VRF routing table
into the BGP process it will add the configured export extended community(ies)
for that VPN. When that route needs to go from BGP into the VRF routing table
will only pass if that given VPN import policy matches any of the appended
community(ies) into that prefix.</p>
</section>
<section id="topology">
<h2>Topology<a class="headerlink" href="#topology" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="../images/inter-vrf-routing-vrf-lite.png"><img alt="Network Topology Diagram" class="align-center" src="../images/inter-vrf-routing-vrf-lite.png" style="width: 70%;" />
</a>
<section id="ip-schema">
<h3>IP Schema<a class="headerlink" href="#ip-schema" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Device-A</p></td>
<td><p>Device-B</p></td>
<td><p>IPv4 Network</p></td>
<td><p>IPv6 Network</p></td>
</tr>
<tr class="row-even"><td><p>Core</p></td>
<td><p>LAN1</p></td>
<td><p>10.1.1.0/30</p></td>
<td><p>2001:db8::/127</p></td>
</tr>
<tr class="row-odd"><td><p>Core</p></td>
<td><p>LAN2</p></td>
<td><p>172.16.2.0/30</p></td>
<td><p>2001:db8::2/127</p></td>
</tr>
<tr class="row-even"><td><p>Core</p></td>
<td><p>Management</p></td>
<td><p>192.168.3.0/30</p></td>
<td><p>2001:db8::4/127</p></td>
</tr>
<tr class="row-odd"><td><p>Core</p></td>
<td><p>ISP</p></td>
<td><p>10.2.2.0/30</p></td>
<td><p>2001:db8::6/127</p></td>
</tr>
</tbody>
</table>
</section>
<section id="rd-rt-schema">
<h3>RD &amp; RT Schema<a class="headerlink" href="#rd-rt-schema" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>VRF</p></td>
<td><p>RD</p></td>
<td><p>RT</p></td>
</tr>
<tr class="row-even"><td><p>LAN1</p></td>
<td><p>64496:1</p></td>
<td><p>64496:1</p></td>
</tr>
<tr class="row-odd"><td><p>LAN2</p></td>
<td><p>64496:2</p></td>
<td><p>64496:2</p></td>
</tr>
<tr class="row-even"><td><p>Management</p></td>
<td><p>64496:50</p></td>
<td><p>64496:50</p></td>
</tr>
<tr class="row-odd"><td><p>Internet</p></td>
<td><p>64496:100</p></td>
<td><p>64496:100</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="configurations">
<h2>Configurations<a class="headerlink" href="#configurations" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use a static route configuration in between the Core and each
LAN and Management router, and BGP between the Core router and the ISP router
but any dynamic routing protocol can be used.</p>
</div>
<section id="remote-networks">
<h3>Remote Networks<a class="headerlink" href="#remote-networks" title="Link to this heading"></a></h3>
<p>The following template configuration can be used in each remote router based
in our topology.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Interface Configuration
set interface eth eth&lt;N&gt; address &lt;IP ADDRESS/CIDR&gt;

# Static default route back to Core
set procotols static route 0.0.0.0/0 next-hop &lt;CORE IP ADDRESS&gt;
</pre></div>
</div>
</section>
<section id="core-router">
<h3>Core Router<a class="headerlink" href="#core-router" title="Link to this heading"></a></h3>
<section id="step-1-vrf-and-configurations-to-remote-networks">
<h4>Step 1: VRF and Configurations to remote networks<a class="headerlink" href="#step-1-vrf-and-configurations-to-remote-networks" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Configuration</p></li>
</ul>
<p>Set the VRF name and Table ID, set interface address and bind it to the VRF.
Last add the static route to the remote network.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># VRF name and table ID (MANDATORY)
set vrf name &lt;VRF&gt; table &lt;ID&gt;

# Interface Configuration
set interface eth eth&lt;N&gt; address &lt;IP ADDRESS/CIDR&gt;

# Assign interface to VRF
set interface eth eth&lt;N&gt; vrf &lt;VRF&gt;

# Static route to remote Network
set vrf name &lt;VRF&gt; protocols static route &lt;NETWORK/CIDR&gt; next-hop &lt;REMOTE IP ADDRESS&gt;
</pre></div>
</div>
<ul class="simple">
<li><p>Verification</p></li>
</ul>
<p>Checking the routing table of the VRF should reveal both static and connected
entries active. A PING test between the Core and remote router is a way to
validate connectivity within the VRF.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># show ip route vrf &lt;VRF&gt;
# show ipv6 route vrf &lt;VRF&gt;

vyos@Core:~$ show ip route vrf LAN1
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

VRF LAN1:
S&gt;* 10.0.0.0/24 [1/0] via 10.1.1.2, eth0, weight 1, 00:05:41
C&gt;* 10.1.1.0/30 is directly connected, eth0, 00:05:44

vyos@Core:~$ show ipv6 route vrf LAN1
Codes: K - kernel route, C - connected, S - static, R - RIPng,
       O - OSPFv3, I - IS-IS, B - BGP, N - NHRP, T - Table,
       v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

VRF LAN1:
C&gt;* 2001:db8::/127 is directly connected, eth0, 00:18:43
S&gt;* 2001:db8:0:1::/64 [1/0] via 2001:db8::1, eth0, weight 1, 00:16:03
C&gt;* fe80::/64 is directly connected, eth0, 00:18:43

# ping &lt;DESTINATION&gt; vrf &lt;VRF&gt;

vyos@Core:~$ ping 10.1.1.2 vrf LAN1
PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.
64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=1.52 ms
64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.830 ms
^C
--- 10.1.1.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 0.830/1.174/1.518/0.344 ms
vyos@Core:~$ ping 10.0.0.1 vrf LAN1
PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.
64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.785 ms
64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.948 ms
^C
--- 10.0.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 0.785/0.866/0.948/0.081 ms

vyos@Core:~$ ping 2001:db8:0:1::1 vrf LAN1
PING 2001:db8:0:1::1(2001:db8:0:1::1) 56 data bytes
64 bytes from 2001:db8:0:1::1: icmp_seq=1 ttl=64 time=3.04 ms
64 bytes from 2001:db8:0:1::1: icmp_seq=2 ttl=64 time=1.04 ms
64 bytes from 2001:db8:0:1::1: icmp_seq=3 ttl=64 time=0.925 ms
^C
--- 2001:db8:0:1::1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 0.925/1.665/3.035/0.969 ms
</pre></div>
</div>
</section>
<section id="step-2-bgp-configuration-for-vrf-lite">
<h4>Step 2: BGP Configuration for VRF-Lite<a class="headerlink" href="#step-2-bgp-configuration-for-vrf-lite" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Configuration</p></li>
</ul>
<p>Setting BGP global local-as as well inside the VRF. Redistribute static routes
to inject configured networks into the BGP process but still inside the VRF.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># set BGP global local-as
set protocols bgp system-as &lt;ASN&gt;

# set BGP VRF local-as and redistribution
set vrf name &lt;VRF&gt; protocols bgp system-as &lt;ASN&gt;
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; redistribute static
</pre></div>
</div>
<ul class="simple">
<li><p>Verification</p></li>
</ul>
<p>Check the BGP VRF table and verify if the static routes are injected showing
the correct next-hop information.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># show ip bgp vrf &lt;VRF&gt;
# show bgp vrf &lt;VRF&gt; ipv6

vyos@Core:~$ show ip bgp vrf LAN1
BGP table version is 3, local router ID is 10.1.1.1, vrf id 8
Default local pref 100, local AS 64496
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop&#39;s vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.0/24      10.1.1.2                 0         32768 ?

vyos@Core# run show bgp vrf LAN1 ipv6
BGP table version is 13, local router ID is 10.1.1.1, vrf id 8
Default local pref 100, local AS 64496
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop&#39;s vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 2001:db8:0:1::/64
                    2001:db8::1              0         32768 ?
</pre></div>
</div>
</section>
<section id="step-3-vpn-configuration">
<h4>Step 3: VPN Configuration<a class="headerlink" href="#step-3-vpn-configuration" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Configuration</p></li>
</ul>
<p>Within the VRF we set the Route-Distinguisher (RD) and Route-Targets (RT), then
we enable the export/import VPN.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># set Route-distinguisher
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; rd vpn export &#39;&lt;RD&gt;&#39;

# set route-target for import/export
# Note: RT are a list that can be more than one community between apostrophe
#       and separated by blank space. Ex: &#39;&lt;RT:1&gt; &lt;RT:2&gt; &lt;RT:3&gt;&#39;
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; route-target vpn export &#39;&lt;RT:Export&gt;&#39;
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; route-target vpn import &#39;&lt;RT:Import&gt;&#39;

# Enable VPN export/import under this VRF
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; export vpn
set vrf name &lt;VRF&gt; protocols bgp address-family &lt;AF IPv4/IPv6&gt; import vpn
</pre></div>
</div>
<p>A key point to understand is that if we need two VRFs to communicate between
each other EXPORT rt from VRF1 has to be in the IMPORT rt list from VRF2. But
this is only in ONE direction, to complete the communication the EXPORT rt from
VRF2 has to be in the IMPORT rt list from VRF1.</p>
<p>There are some cases where this is not needed -for example, in some
DDoS appliance- but most inter-vrf routing designs use the above configurations.</p>
<ul class="simple">
<li><p>Verification</p></li>
</ul>
<p>After configured all the VRFs involved in this topology we take a deeper look
at both BGP and Routing table for the VRF LAN1</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># show ip bgp vrf &lt;VRF&gt;
# show bgp vrf &lt;VRF&gt; ipv6

vyos@Core# run show ip bgp vrf LAN1
BGP table version is 53, local router ID is 10.1.1.1, vrf id 8
Default local pref 100, local AS 64496
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop&#39;s vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 0.0.0.0/0        10.2.2.2@7&lt;                            0 64497 i
*&gt; 10.0.0.0/24      10.1.1.2                 0         32768 ?
*&gt; 10.2.2.0/30      10.2.2.2@7&lt;              0             0 64497 ?
*&gt; 192.0.2.0/24     10.2.2.2@7&lt;              0             0 64497 ?
*&gt; 192.168.0.0/24   192.168.3.2@11&lt;          0         32768 ?
*&gt; 198.51.100.0/24  10.2.2.2@7&lt;              0             0 64497 ?
*&gt; 203.0.113.0/24   10.2.2.2@7&lt;              0             0 64497 ?

vyos@Core# run show bgp vrf LAN1 ipv6
BGP table version is 13, local router ID is 10.1.1.1, vrf id 8
Default local pref 100, local AS 64496
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop&#39;s vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

Network          Next Hop            Metric LocPrf Weight Path
*&gt; ::/0             fe80::5200:ff:fe02:3@7&lt;
                                                           0 64497 i
*&gt; 2001:db8::6/127  fe80::5200:ff:fe02:3@7&lt;
                                             0             0 64497 ?
*&gt; 2001:db8:0:1::/64
                    2001:db8::1              0         32768 ?
*&gt; 2001:db8:0:3::/64
                    2001:db8::5@11&lt;          0         32768 ?
*&gt; 2001:db8:1::/48  fe80::5200:ff:fe02:3@7&lt;
                                             0             0 64497 ?
*&gt; 2001:db8:2::/48  fe80::5200:ff:fe02:3@7&lt;
                                             0             0 64497 ?
*&gt; 2001:db8:3::/48  fe80::5200:ff:fe02:3@7&lt;
                                             0             0 64497 ?


# show ip route vrf &lt;VRF&gt;
# show ipv6 route vrf &lt;VRF&gt;

vyos@Core:~$ show ip route vrf LAN1
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

VRF LAN1:
B&gt;* 0.0.0.0/0 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:00:38
S&gt;* 10.0.0.0/24 [1/0] via 10.1.1.2, eth0, weight 1, 00:29:57
C&gt;* 10.1.1.0/30 is directly connected, eth0, 00:29:59
B   10.2.2.0/30 [20/0] via 10.2.2.2 (vrf Internet) inactive, weight 1, 00:00:38
B&gt;* 172.16.0.0/24 [20/0] via 172.16.2.2, eth1 (vrf LAN2), weight 1, 00:00:38
B&gt;* 192.0.2.0/24 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:00:38
B&gt;* 198.51.100.0/24 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:00:38
B&gt;* 203.0.113.0/24 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:00:38

vyos@Core# run show ipv6 route vrf LAN1
Codes: K - kernel route, C - connected, S - static, R - RIPng,
       O - OSPFv3, I - IS-IS, B - BGP, N - NHRP, T - Table,
       v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

VRF LAN1:
B&gt;* ::/0 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:07:50
C&gt;* 2001:db8::/127 is directly connected, eth0, 05:33:43
B&gt;* 2001:db8::6/127 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:07:50
S&gt;* 2001:db8:0:1::/64 [1/0] via 2001:db8::1, eth0, weight 1, 05:31:03
B&gt;* 2001:db8:0:3::/64 [20/0] via 2001:db8::5, eth2 (vrf Management), weight 1, 00:07:50
B&gt;* 2001:db8:1::/48 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:07:50
B&gt;* 2001:db8:2::/48 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:07:50
B&gt;* 2001:db8:3::/48 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:07:50
C&gt;* fe80::/64 is directly connected, eth0, 05:33:43
</pre></div>
</div>
<p>As we can see in the BGP table any imported route has been injected with a “&#64;”
followed by the VPN id; In the routing table of the VRF, if the route was
installed, we can see -between round brackets- the exported VRF table.</p>
</section>
<section id="step-4-end-to-end-verification">
<h4>Step 4: End to End verification<a class="headerlink" href="#step-4-end-to-end-verification" title="Link to this heading"></a></h4>
<p>Now we perform some end-to-end testing</p>
<ul class="simple">
<li><p>From Management to LAN1/LAN2</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@Management:~$ ping 10.0.0.1 source-address 192.168.0.1
PING 10.0.0.1 (10.0.0.1) from 192.168.0.1 : 56(84) bytes of data.
64 bytes from 10.0.0.1: icmp_seq=1 ttl=63 time=1.93 ms
64 bytes from 10.0.0.1: icmp_seq=2 ttl=63 time=2.12 ms
64 bytes from 10.0.0.1: icmp_seq=3 ttl=63 time=2.12 ms
^C
--- 10.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2005ms
rtt min/avg/max/mdev = 1.931/2.056/2.123/0.088 ms
vyos@Management:~$ ping 172.16.0.1 source-address 192.168.0.1
PING 172.16.0.1 (172.16.0.1) from 192.168.0.1 : 56(84) bytes of data.
64 bytes from 172.16.0.1: icmp_seq=1 ttl=63 time=1.62 ms
64 bytes from 172.16.0.1: icmp_seq=2 ttl=63 time=1.75 ms
^C
--- 172.16.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 1.621/1.686/1.752/0.065 ms
vyos@Management:~$ ping 2001:db8:0:1::1 source-address 2001:db8:0:3::1
PING 2001:db8:0:1::1(2001:db8:0:1::1) from 2001:db8:0:3::1 : 56 data bytes
64 bytes from 2001:db8:0:1::1: icmp_seq=1 ttl=63 time=2.44 ms
64 bytes from 2001:db8:0:1::1: icmp_seq=2 ttl=63 time=2.40 ms
64 bytes from 2001:db8:0:1::1: icmp_seq=3 ttl=63 time=2.41 ms
^C
--- 2001:db8:0:1::1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 2.399/2.418/2.442/0.017 ms
vyos@Management:~$ ping 2001:db8:0:2::1 source-address 2001:db8:0:3::1
PING 2001:db8:0:2::1(2001:db8:0:2::1) from 2001:db8:0:3::1 : 56 data bytes
64 bytes from 2001:db8:0:2::1: icmp_seq=1 ttl=63 time=1.66 ms
64 bytes from 2001:db8:0:2::1: icmp_seq=2 ttl=63 time=1.99 ms
64 bytes from 2001:db8:0:2::1: icmp_seq=3 ttl=63 time=1.88 ms
64 bytes from 2001:db8:0:2::1: icmp_seq=4 ttl=63 time=2.32 ms
^C
--- 2001:db8:0:2::1 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 1.660/1.960/2.315/0.236 ms
</pre></div>
</div>
<ul class="simple">
<li><p>From Management to Outside (fails as intended)</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@Management:~$ show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

S&gt;* 0.0.0.0/0 [1/0] via 192.168.3.1, eth2, weight 1, 00:01:58
C&gt;* 192.168.0.0/24 is directly connected, dum0, 00:02:05
C&gt;* 192.168.3.0/30 is directly connected, eth2, 00:02:03
vyos@Management:~$ ping 192.0.2.1
PING 192.0.2.1 (192.0.2.1) 56(84) bytes of data.
From 192.168.3.1 icmp_seq=1 Destination Net Unreachable
From 192.168.3.1 icmp_seq=2 Destination Net Unreachable
^C
--- 192.0.2.1 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1002ms

vyos@Management:~$ ping 195.51.100.1
PING 195.51.100.1 (195.51.100.1) 56(84) bytes of data.
From 192.168.3.1 icmp_seq=1 Destination Net Unreachable
From 192.168.3.1 icmp_seq=2 Destination Net Unreachable
From 192.168.3.1 icmp_seq=3 Destination Net Unreachable
^C
--- 195.51.100.1 ping statistics ---
3 packets transmitted, 0 received, +3 errors, 100% packet loss, time 2003ms

vyos@Management:~$ ping 2001:db8:1::1
PING 2001:db8:1::1(2001:db8:1::1) 56 data bytes
From 2001:db8::4 icmp_seq=1 Destination unreachable: No route
From 2001:db8::4 icmp_seq=2 Destination unreachable: No route
^C
--- 2001:db8:1::1 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1002ms

vyos@Management:~$ ping 2001:db8:2::1
PING 2001:db8:2::1(2001:db8:2::1) 56 data bytes
From 2001:db8::4 icmp_seq=1 Destination unreachable: No route
From 2001:db8::4 icmp_seq=2 Destination unreachable: No route
^C
--- 2001:db8:2::1 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1002ms
</pre></div>
</div>
<ul class="simple">
<li><p>LAN1 to Outside</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@LAN1:~$ ping 192.0.2.1 source-address 10.0.0.1
PING 192.0.2.1 (192.0.2.1) from 10.0.0.1 : 56(84) bytes of data.
64 bytes from 192.0.2.1: icmp_seq=1 ttl=63 time=1.47 ms
64 bytes from 192.0.2.1: icmp_seq=2 ttl=63 time=1.41 ms
64 bytes from 192.0.2.1: icmp_seq=3 ttl=63 time=1.80 ms
^C
--- 192.0.2.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 1.414/1.563/1.803/0.171 ms
vyos@LAN1:~$ ping 198.51.100.1 source-address 10.0.0.1
PING 198.51.100.1 (198.51.100.1) from 10.0.0.1 : 56(84) bytes of data.
64 bytes from 198.51.100.1: icmp_seq=1 ttl=63 time=1.71 ms
64 bytes from 198.51.100.1: icmp_seq=2 ttl=63 time=1.83 ms
^C
--- 198.51.100.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 1.705/1.766/1.828/0.061 ms
vyos@LAN1:~$ ping 203.0.113.1 source-address 10.0.0.1
PING 203.0.113.1 (203.0.113.1) from 10.0.0.1 : 56(84) bytes of data.
64 bytes from 203.0.113.1: icmp_seq=1 ttl=63 time=1.25 ms
64 bytes from 203.0.113.1: icmp_seq=2 ttl=63 time=1.88 ms
^C
--- 203.0.113.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1003ms
rtt min/avg/max/mdev = 1.249/1.566/1.884/0.317 ms
vyos@LAN1:~$ ping 2001:db8:1::1 source-address 2001:db8:0:1::1
PING 2001:db8:1::1(2001:db8:1::1) from 2001:db8:0:1::1 : 56 data bytes
64 bytes from 2001:db8:1::1: icmp_seq=1 ttl=63 time=2.35 ms
64 bytes from 2001:db8:1::1: icmp_seq=2 ttl=63 time=2.29 ms
64 bytes from 2001:db8:1::1: icmp_seq=3 ttl=63 time=2.22 ms
^C
--- 2001:db8:1::1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 2.215/2.285/2.352/0.055 ms
vyos@LAN1:~$ ping 2001:db8:2::1 source-address 2001:db8:0:1::1
PING 2001:db8:2::1(2001:db8:2::1) from 2001:db8:0:1::1 : 56 data bytes
64 bytes from 2001:db8:2::1: icmp_seq=1 ttl=63 time=1.37 ms
64 bytes from 2001:db8:2::1: icmp_seq=2 ttl=63 time=2.68 ms
64 bytes from 2001:db8:2::1: icmp_seq=3 ttl=63 time=2.00 ms
^C
--- 2001:db8:2::1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 1.367/2.015/2.679/0.535 ms
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>we are using “source-address” option cause we are not redistributing
connected interfaces into BGP on the Core router hence there is no comeback
route and ping will fail.</p>
</div>
<ul class="simple">
<li><p>LAN1 to LAN2</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@LAN1:~$ ping 172.16.0.1 source-address 10.0.0.1
PING 172.16.0.1 (172.16.0.1) from 10.0.0.1 : 56(84) bytes of data.
64 bytes from 172.16.0.1: icmp_seq=1 ttl=63 time=3.00 ms
64 bytes from 172.16.0.1: icmp_seq=2 ttl=63 time=2.20 ms
^C
--- 172.16.0.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 2.199/2.600/3.001/0.401 ms
vyos@LAN1:~$ ping 2001:db8:0:2::1 source 2001:db8:0:1::1
PING 2001:db8:0:2::1(2001:db8:0:2::1) from 2001:db8:0:1::1 : 56 data bytes
64 bytes from 2001:db8:0:2::1: icmp_seq=1 ttl=63 time=4.82 ms
64 bytes from 2001:db8:0:2::1: icmp_seq=2 ttl=63 time=1.95 ms
64 bytes from 2001:db8:0:2::1: icmp_seq=3 ttl=63 time=1.98 ms
^C
--- 2001:db8:0:2::1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 1.949/2.915/4.815/1.343 ms
</pre></div>
</div>
</section>
</section>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading"></a></h2>
<p>Inter-VRF routing is a well-known solution to address complex routing scenarios
that enable -in a dynamic way- to leak routes between VRFs. Is recommended to
take special consideration while designing route-targets and its application as
it can minimize future interventions while creating a new VRF will automatically
take the desired effect in its propagation.</p>
</section>
<section id="appendix-a">
<h2>Appendix-A<a class="headerlink" href="#appendix-a" title="Link to this heading"></a></h2>
<section id="full-configuration-from-all-devices">
<h3>Full configuration from all devices<a class="headerlink" href="#full-configuration-from-all-devices" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Core</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces ethernet eth0 address &#39;10.1.1.1/30&#39;
set interfaces ethernet eth0 address &#39;2001:db8::/127&#39;
set interfaces ethernet eth0 vrf &#39;LAN1&#39;
set interfaces ethernet eth1 address &#39;172.16.2.1/30&#39;
set interfaces ethernet eth1 address &#39;2001:db8::2/127&#39;
set interfaces ethernet eth1 vrf &#39;LAN2&#39;
set interfaces ethernet eth2 address &#39;192.168.3.1/30&#39;
set interfaces ethernet eth2 address &#39;2001:db8::4/127&#39;
set interfaces ethernet eth2 vrf &#39;Management&#39;
set interfaces ethernet eth3 address &#39;10.2.2.1/30&#39;
set interfaces ethernet eth3 address &#39;2001:db8::6/127&#39;
set interfaces ethernet eth3 vrf &#39;Internet&#39;
set protocols bgp address-family ipv4-unicast
set protocols bgp system-as &#39;64496&#39;
set vrf name Internet protocols bgp address-family ipv4-unicast export vpn
set vrf name Internet protocols bgp address-family ipv4-unicast import vpn
set vrf name Internet protocols bgp address-family ipv4-unicast rd vpn export &#39;64496:100&#39;
set vrf name Internet protocols bgp address-family ipv4-unicast route-target vpn export &#39;64496:100&#39;
set vrf name Internet protocols bgp address-family ipv4-unicast route-target vpn import &#39;64496:1 64496:2&#39;
set vrf name Internet protocols bgp address-family ipv6-unicast export vpn
set vrf name Internet protocols bgp address-family ipv6-unicast import vpn
set vrf name Internet protocols bgp address-family ipv6-unicast rd vpn export &#39;64496:100&#39;
set vrf name Internet protocols bgp address-family ipv6-unicast route-target vpn export &#39;64496:100&#39;
set vrf name Internet protocols bgp address-family ipv6-unicast route-target vpn import &#39;64496:1 64496:2&#39;
set vrf name Internet protocols bgp system-as &#39;64496&#39;
set vrf name Internet protocols bgp neighbor 10.2.2.2 address-family ipv4-unicast
set vrf name Internet protocols bgp neighbor 10.2.2.2 remote-as &#39;64497&#39;
set vrf name Internet protocols bgp neighbor 2001:db8::7 address-family ipv6-unicast
set vrf name Internet protocols bgp neighbor 2001:db8::7 remote-as &#39;64497&#39;
set vrf name Internet table &#39;104&#39;
set vrf name LAN1 protocols bgp address-family ipv4-unicast export vpn
set vrf name LAN1 protocols bgp address-family ipv4-unicast import vpn
set vrf name LAN1 protocols bgp address-family ipv4-unicast rd vpn export &#39;64496:1&#39;
set vrf name LAN1 protocols bgp address-family ipv4-unicast redistribute static
set vrf name LAN1 protocols bgp address-family ipv4-unicast route-target vpn export &#39;64496:1&#39;
set vrf name LAN1 protocols bgp address-family ipv4-unicast route-target vpn import &#39;64496:100 64496:50 64496:2&#39;
set vrf name LAN1 protocols bgp address-family ipv6-unicast export vpn
set vrf name LAN1 protocols bgp address-family ipv6-unicast import vpn
set vrf name LAN1 protocols bgp address-family ipv6-unicast rd vpn export &#39;64496:1&#39;
set vrf name LAN1 protocols bgp address-family ipv6-unicast redistribute static
set vrf name LAN1 protocols bgp address-family ipv6-unicast route-target vpn export &#39;64496:1&#39;
set vrf name LAN1 protocols bgp address-family ipv6-unicast route-target vpn import &#39;64496:100 64496:50 64496:2&#39;
set vrf name LAN1 protocols bgp system-as &#39;64496&#39;
set vrf name LAN1 protocols static route 10.0.0.0/24 next-hop 10.1.1.2
set vrf name LAN1 protocols static route6 2001:db8:0:1::/64 next-hop 2001:db8::1
set vrf name LAN1 table &#39;101&#39;
set vrf name LAN2 protocols bgp address-family ipv4-unicast export vpn
set vrf name LAN2 protocols bgp address-family ipv4-unicast import vpn
set vrf name LAN2 protocols bgp address-family ipv4-unicast rd vpn export &#39;64496:2&#39;
set vrf name LAN2 protocols bgp address-family ipv4-unicast redistribute static
set vrf name LAN2 protocols bgp address-family ipv4-unicast route-target vpn export &#39;64496:2&#39;
set vrf name LAN2 protocols bgp address-family ipv4-unicast route-target vpn import &#39;64496:100 64496:50 64496:1&#39;
set vrf name LAN2 protocols bgp address-family ipv6-unicast export vpn
set vrf name LAN2 protocols bgp address-family ipv6-unicast import vpn
set vrf name LAN2 protocols bgp address-family ipv6-unicast rd vpn export &#39;64496:2&#39;
set vrf name LAN2 protocols bgp address-family ipv6-unicast redistribute static
set vrf name LAN2 protocols bgp address-family ipv6-unicast route-target vpn export &#39;64496:2&#39;
set vrf name LAN2 protocols bgp address-family ipv6-unicast route-target vpn import &#39;64496:100 64496:50 64496:1&#39;
set vrf name LAN2 protocols bgp system-as &#39;64496&#39;
set vrf name LAN2 protocols static route 172.16.0.0/24 next-hop 172.16.2.2
set vrf name LAN2 protocols static route6 2001:db8:0:2::/64 next-hop 2001:db8::3
set vrf name LAN2 table &#39;102&#39;
set vrf name Management protocols bgp address-family ipv4-unicast export vpn
set vrf name Management protocols bgp address-family ipv4-unicast import vpn
set vrf name Management protocols bgp address-family ipv4-unicast rd vpn export &#39;64496:50&#39;
set vrf name Management protocols bgp address-family ipv4-unicast redistribute static
set vrf name Management protocols bgp address-family ipv4-unicast route-target vpn export &#39;64496:50&#39;
set vrf name Management protocols bgp address-family ipv4-unicast route-target vpn import &#39;64496:1 64496:2&#39;
set vrf name Management protocols bgp address-family ipv6-unicast export vpn
set vrf name Management protocols bgp address-family ipv6-unicast import vpn
set vrf name Management protocols bgp address-family ipv6-unicast rd vpn export &#39;64496:50&#39;
set vrf name Management protocols bgp address-family ipv6-unicast redistribute static
set vrf name Management protocols bgp address-family ipv6-unicast route-target vpn export &#39;64496:50&#39;
set vrf name Management protocols bgp address-family ipv6-unicast route-target vpn import &#39;64496:1 64496:2&#39;
set vrf name Management protocols bgp system-as &#39;64496&#39;
set vrf name Management protocols static route 192.168.0.0/24 next-hop 192.168.3.2
set vrf name Management protocols static route6 2001:db8:0:3::/64 next-hop 2001:db8::5
set vrf name Management table &#39;103&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>LAN1</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;10.0.0.1/24&#39;
set interfaces dummy dum0 address &#39;2001:db8:0:1::1/64&#39;
set interfaces ethernet eth0 address &#39;10.1.1.2/30&#39;
set interfaces ethernet eth0 address &#39;2001:db8::1/127&#39;
set protocols static route 0.0.0.0/0 next-hop 10.1.1.1
set protocols static route6 ::/0 next-hop 2001:db8::*
</pre></div>
</div>
<ul class="simple">
<li><p>LAN2</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;172.16.0.1/24&#39;
set interfaces dummy dum0 address &#39;2001:db8:0:2::1/64&#39;
set interfaces ethernet eth0 hw-id &#39;50:00:00:03:00:00&#39;
set interfaces ethernet eth1 address &#39;172.16.2.2/30&#39;
set interfaces ethernet eth1 address &#39;2001:db8::3/127&#39;
set protocols static route 0.0.0.0/0 next-hop 172.16.2.1
set protocols static route6 ::/0 next-hop 2001:db8::2
</pre></div>
</div>
<ul class="simple">
<li><p>Management</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;192.168.0.1/24&#39;
set interfaces dummy dum0 address &#39;2001:db8:0:3::1/64&#39;
set interfaces ethernet eth2 address &#39;192.168.3.2/30&#39;
set interfaces ethernet eth2 address &#39;2001:db8::5/127&#39;
set protocols static route 0.0.0.0/0 next-hop 192.168.3.1
set protocols static route6 ::/0 next-hop 2001:db8::4
</pre></div>
</div>
<ul class="simple">
<li><p>ISP</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;192.0.2.1/24&#39;
set interfaces dummy dum0 address &#39;2001:db8:1::1/48&#39;
set interfaces dummy dum1 address &#39;198.51.100.1/24&#39;
set interfaces dummy dum1 address &#39;2001:db8:2::1/48&#39;
set interfaces dummy dum2 address &#39;203.0.113.1/24&#39;
set interfaces dummy dum2 address &#39;2001:db8:3::1/48&#39;
set interfaces ethernet eth3 address &#39;10.2.2.2/30&#39;
set interfaces ethernet eth3 address &#39;2001:db8::7/127&#39;
set protocols bgp address-family ipv4-unicast redistribute connected
set protocols bgp address-family ipv6-unicast redistribute connected
set protocols bgp system-as &#39;64497&#39;
set protocols bgp neighbor 10.2.2.1 address-family ipv4-unicast default-originate
set protocols bgp neighbor 10.2.2.1 remote-as &#39;64496&#39;
set protocols bgp neighbor 2001:db8::6 address-family ipv6-unicast default-originate
set protocols bgp neighbor 2001:db8::6 remote-as &#39;64496&#39;
set protocols static route 0.0.0.0/0 next-hop 10.2.2.1
set protocols static route6 ::/0 next-hop 2001:db8::6
</pre></div>
</div>
</section>
</section>
<section id="appendix-b">
<h2>Appendix-B<a class="headerlink" href="#appendix-b" title="Link to this heading"></a></h2>
<section id="route-filtering">
<h3>Route-Filtering<a class="headerlink" href="#route-filtering" title="Link to this heading"></a></h3>
<p>When importing routes using MP-BGP it is possible to filter a subset of them
before are injected in the BGP table. One of the most common case is to use a
route-map with an prefix-list.</p>
<ul class="simple">
<li><p>Configuration</p></li>
</ul>
<p>We create a prefix-list first and add all the routes we need to.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># set both ipv4 and ipv6 policies

set policy prefix-list LAN2-Internet rule 1 action &#39;permit&#39;
set policy prefix-list LAN2-Internet rule 1 le &#39;24&#39;
set policy prefix-list LAN2-Internet rule 1 prefix &#39;198.51.0.0/16&#39;
set policy prefix-list LAN2-Internet rule 2 action &#39;permit&#39;
set policy prefix-list LAN2-Internet rule 2 prefix &#39;192.0.2.0/24&#39;
set policy prefix-list LAN2-Internet rule 3 action &#39;permit&#39;
set policy prefix-list LAN2-Internet rule 3 prefix &#39;192.168.0.0/24&#39;
set policy prefix-list LAN2-Internet rule 4 action &#39;permit&#39;
set policy prefix-list LAN2-Internet rule 4 prefix &#39;10.0.0.0/24&#39;

set policy prefix-list6 LAN2-Internet-v6 rule 1 action &#39;permit&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 1 prefix &#39;2001:db8:1::/48&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 2 action &#39;permit&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 2 prefix &#39;2001:db8:2::/48&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 3 action &#39;permit&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 3 prefix &#39;2001:db8:0:3::/64&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 4 action &#39;permit&#39;
set policy prefix-list6 LAN2-Internet-v6 rule 4 prefix &#39;2001:db8:0:1::/64&#39;
</pre></div>
</div>
<p>Then add a route-map and reference to above prefix. Consider that the actions
taken inside the prefix will MATCH the routes that will be affected by the
actions inside the rules of the route-map.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set policy route-map LAN2-Internet rule 1 action &#39;permit&#39;
set policy route-map LAN2-Internet rule 1 match ip address prefix-list &#39;LAN2-Internet&#39;

set policy route-map LAN2-Internet-v6 rule 1 action &#39;permit&#39;
set policy route-map LAN2-Internet-v6 rule 1 match ipv6 address prefix-list &#39;LAN2-Internet-v6&#39;
</pre></div>
</div>
<p>We are using a “white list” approach by allowing only what is necessary. In case
that need to implement a “black list” approach then you will need to change the
action in the route-map for a deny BUT you need to add a rule that permits the
rest due to the implicit deny in the route-map.</p>
<p>Then we need to attach the policy to the BGP process. This needs to be under
the import statement in the vrf we need to filter.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set vrf name LAN2 protocols bgp address-family ipv4-unicast route-map vpn import &#39;LAN2-Internet&#39;
set vrf name LAN2 protocols bgp address-family ipv6-unicast route-map vpn import &#39;LAN2-Internet-v6&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>Verification</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># show ip route vrf LAN2

B&gt;* 10.0.0.0/24 [20/0] via 10.1.1.2, eth0 (vrf LAN1), weight 1, 00:45:28
S&gt;* 172.16.0.0/24 [1/0] via 172.16.2.2, eth1, weight 1, 00:45:32
C&gt;* 172.16.2.0/30 is directly connected, eth1, 00:45:39
B&gt;* 192.0.2.0/24 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:45:24
B&gt;* 192.168.0.0/24 [20/0] via 192.168.3.2, eth2 (vrf Managment), weight 1, 00:45:27
B&gt;* 198.51.100.0/24 [20/0] via 10.2.2.2, eth3 (vrf Internet), weight 1, 00:45:24

# show ipv6 route vrf LAN2

C&gt;* 2001:db8::2/127 is directly connected, eth1, 00:46:26
B&gt;* 2001:db8:0:1::/64 [20/0] via 2001:db8::1, eth0 (vrf LAN1), weight 1, 00:46:17
S&gt;* 2001:db8:0:2::/64 [1/0] via 2001:db8::3, eth1, weight 1, 00:46:21
B&gt;* 2001:db8:0:3::/64 [20/0] via 2001:db8::5, eth2 (vrf Managment), weight 1, 00:46:16
B&gt;* 2001:db8:1::/48 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:46:13
B&gt;* 2001:db8:2::/48 [20/0] via fe80::5200:ff:fe02:3, eth3 (vrf Internet), weight 1, 00:46:13
C&gt;* fe80::/64 is directly connected, eth1, 00:46:27
</pre></div>
</div>
<p>As we can see even if both VRF LAN1 and LAN2 has the same import RTs we are able
to select which routes are effectively imported and installed.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lac-lns.html" class="btn btn-neutral float-left" title="PPPoE over L2TP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="qos.html" class="btn btn-neutral float-right" title="QoS example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2024, VyOS maintainers and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <head>
      <style>
          #branch-select-container {
              position: fixed;
              bottom: 10px;
              right: 10px;
              background-color: #f0f0f0;
              padding: 5px;
              border: 1px solid #ccc;
              border-radius: 5px;
          }
      </style>
  </head>
  <body>
      <div id="branch-select-container">
          <select id="branch-select">
              <option value="sagitta">Sagitta</option>
              <option value="circinus">Circinus</option>
          </select>
      </div>
      <script>
          // Define the branches
          const branches = ['sagitta', 'circinus'];
  
          // Get the current branch name from the URL
          const currentUrl = window.location.href;
          const currentBranch = branches.find(branch => currentUrl.includes(branch));
  
          // Set the selected option in the dropdown
          const branchSelect = document.getElementById('branch-select');
          branchSelect.value = currentBranch;
  
          // Add an event listener to the dropdown
          branchSelect.addEventListener('change', () => {
              const newBranch = branchSelect.value;
              const newUrl = currentUrl.replace(currentBranch, newBranch);
              window.location.href = newUrl;
          });
      </script>
  </body>


</body>
</html>