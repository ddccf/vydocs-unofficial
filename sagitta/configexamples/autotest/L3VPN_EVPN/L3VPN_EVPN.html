

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>L3VPN EVPN with VyOS &mdash; VyOS 1.4.x (sagitta) documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../../static/vyos-logo-icon.png"/>
      <script src="../../../static/jquery.js?v=5d32c60e"></script>
      <script src="../../../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../static/documentation_options.js?v=8f5ed1cd"></script>
      <script src="../../../static/doctools.js?v=9bcbadda"></script>
      <script src="../../../static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
    <link rel="next" title="Wireguard" href="../Wireguard/Wireguard.html" />
    <link rel="prev" title="Tunnelbroker.net (IPv6)" href="../tunnelbroker/tunnelbroker.html" />
    <style>#vyos-header-iframe{position:fixed;top:0;left:0;right:0;z-index:999999999;width:100%;border:none}</style>
    <style>#vyos-footer-iframe{width:100%;border:none}</style>
    <link href="../../../static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/lists.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/hints.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/headers.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/breadcrumbs.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/linkButtons.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/text.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/leftSidebar.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/scrolls.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/tables.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/installation/running-on-bare-metal.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/code-snippets.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/separate-commands.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/configuration/index.css" rel="stylesheet" type="text/css">
    <link href="../../../static/css/datatables.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="../../../static/js/datatables.js"></script>
    <script type="text/javascript" charset="utf8" src="../../../static/js/tables.js"></script>
    <script type="text/javascript" charset="utf8" src="../../../static/js/codecopier.js"></script>
    <script type="text/javascript" charset="utf8" src="../../../static/js/sidebar.js"></script>
    <script type="text/javascript" charset="utf8" src="../../../static/js/footer.js"></script>
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            VyOS
              <img src="../../../static/vyos-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introducing/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introducing/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation and Image Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html#configuration-overview">Configuration Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adminguide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operation/index.html">Operation Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../automation/index.html">VyOS Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Configuration Blueprints</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html#configuration-blueprints-autotest">Configuration Blueprints (autotest)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../DHCPRelay_through_GRE/DHCPRelay_through_GRE.html">DHCP Relay trough GRE-Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tunnelbroker/tunnelbroker.html">Tunnelbroker.net (IPv6)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">L3VPN EVPN with VyOS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#management-vrf">Management VRF</a></li>
<li class="toctree-l3"><a class="reference internal" href="#topology">Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="#core-network">Core network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tenant-networks-vrfs">Tenant networks (VRFs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-and-debugging">Testing and debugging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Wireguard/Wireguard.html">Wireguard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../OpenVPN_with_LDAP/OpenVPN_with_LDAP.html">OpenVPN with LDAP</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/build-vyos.html">Build VyOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/issues-features.html">Issues/Feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/upstream-packages.html">Upstream packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Write Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VyOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Configuration Blueprints</a></li>
      <li class="breadcrumb-item active">L3VPN EVPN with VyOS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../sources/configexamples/autotest/L3VPN_EVPN/L3VPN_EVPN.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="l3vpn-evpn-with-vyos">
<h1>L3VPN EVPN with VyOS<a class="headerlink" href="#l3vpn-evpn-with-vyos" title="Link to this heading"></a></h1>
<div class="line-block">
<div class="line">Testdate: 2023-05-11</div>
<div class="line">Version: 1.4-rolling-202305100734</div>
</div>
<p>I spun up a new lab in EVE-NG, which represents this as the
“Foo Bar - Service Provider Inc.” that has 3 points of presence (PoP) in random
datacenters/sites named PE1, PE2, and PE3. Each PoP aggregates at least two
customers.</p>
<p>I named the customers blue, red and green which is common practice in
VRF (Virtual Routing and Forwarding) documentation scenarios.</p>
<ul class="simple">
<li><p>PE1 is located in an industrial area that holds multiple office buildings.
All customers have a site in this area.</p></li>
<li><p>PE2 is located in a smaller area where by coincidence two customers
(blue and red) share an office building.</p></li>
<li><p>PE3 is located in a smaller area where by coincidence two customers
(blue and green) are located.</p></li>
</ul>
<section id="management-vrf">
<h2>Management VRF<a class="headerlink" href="#management-vrf" title="Link to this heading"></a></h2>
<p>A brief excursion into VRFs: This has been one of the longest-standing feature
requests of VyOS (dating back to 2016) which can be described as
“a VLAN for layer 2 is what a VRF is for layer 3”.
With VRFs, a router/system can hold multiple, isolated routing tables on the
same system. If you wonder what’s the difference between multiple tables that
people used for policy-based routing since forever, it’s that a VRF also
isolates connected routes rather than just static and dynamically learned
routes, so it allows NICs in different VRFs to use conflicting network
ranges without issues.</p>
<p>VyOS 1.3 added initial support for VRFs (including IPv4/IPv6 static routing)
and VyOS 1.4 now enables full dynamic routing protocol support for
OSPF, IS-IS, and BGP for individual VRFs.</p>
<p>The lab I built is using a VRF (called <strong>mgmt</strong>) to provide out-of-band
SSH access to the PE (Provider Edge) routers.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set system host-name PE1
set interfaces ethernet eth0 address &#39;dhcp&#39;
set interfaces ethernet eth0 description &#39;out-of-band management&#39;
set interfaces ethernet eth0 vrf &#39;mgmt&#39;
set service ssh vrf &#39;mgmt&#39;
set vrf name mgmt table &#39;1000&#39;
</pre></div>
</div>
</section>
<section id="topology">
<h2>Topology<a class="headerlink" href="#topology" title="Link to this heading"></a></h2>
<p>We use the following network topology in this example:</p>
<img alt="L3VPN EVPN with VyOS topology image" src="../../../images/topology1.png" />
</section>
<section id="core-network">
<h2>Core network<a class="headerlink" href="#core-network" title="Link to this heading"></a></h2>
<p>I chose to run OSPF as the IGP (Interior Gateway Protocol).
All required BGP sessions are established via a dummy interfaces
(similar to the loopback, but in Linux you can have only one loopback,
while there can be many dummy interfaces) on the PE routers. In case of a link
failure, traffic is diverted in the other direction in this triangle setup and
BGP sessions will not go down. One could even enable
BFD (Bidirectional Forwarding Detection) on the links for a faster
failover and resilience in the network.</p>
<p>Regular VyOS users will notice that the BGP syntax has changed in VyOS 1.4 from
even the prior post about this subject. This is due to T1711, where it was
finally decided to get rid of the redundant BGP ASN (Autonomous System Number)
specification on the CLI and move it to a single leaf node
(set protocols bgp local-as).</p>
<p>It’s important to note that all your existing configurations will be migrated
automatically on image upgrade. Nothing to do on your side.</p>
<p>PE1</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;172.29.255.1/32&#39;

set interfaces ethernet eth1 address &#39;172.29.0.2/31&#39;
set interfaces ethernet eth1 description &#39;link to pe2&#39;
set interfaces ethernet eth1 mtu &#39;1600&#39;
set interfaces ethernet eth3 address &#39;172.29.0.6/31&#39;
set interfaces ethernet eth3 description &#39;link to pe3&#39;
set interfaces ethernet eth3 mtu &#39;1600&#39;

set protocols ospf area 0 network &#39;172.29.0.2/31&#39;
set protocols ospf area 0 network &#39;172.29.0.6/31&#39;
set protocols ospf interface eth1 network &#39;point-to-point&#39;
set protocols ospf interface eth3 network &#39;point-to-point&#39;
set protocols ospf interface eth1 passive disable
set protocols ospf interface eth3 passive disable
set protocols ospf log-adjacency-changes detail
set protocols ospf parameters abr-type &#39;cisco&#39;
set protocols ospf parameters router-id &#39;172.29.255.1&#39;
set protocols ospf passive-interface &#39;default&#39;
set protocols ospf redistribute connected

set protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set protocols bgp address-family l2vpn-evpn advertise-all-vni
set protocols bgp system-as &#39;100&#39;
set protocols bgp neighbor 172.29.255.2 peer-group &#39;ibgp&#39;
set protocols bgp neighbor 172.29.255.3 peer-group &#39;ibgp&#39;
set protocols bgp parameters log-neighbor-changes
set protocols bgp parameters router-id &#39;172.29.255.1&#39;
set protocols bgp peer-group ibgp address-family l2vpn-evpn
set protocols bgp peer-group ibgp remote-as &#39;100&#39;
set protocols bgp peer-group ibgp update-source &#39;dum0&#39;
</pre></div>
</div>
<p>PE2</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;172.29.255.2/32&#39;

set interfaces ethernet eth1 address &#39;172.29.0.3/31&#39;
set interfaces ethernet eth1 description &#39;link to pe1&#39;
set interfaces ethernet eth1 mtu &#39;1600&#39;
set interfaces ethernet eth2 address &#39;172.29.0.4/31&#39;
set interfaces ethernet eth2 description &#39;link to pe3&#39;
set interfaces ethernet eth2 mtu &#39;1600&#39;

set protocols ospf area 0 network &#39;172.29.0.2/31&#39;
set protocols ospf area 0 network &#39;172.29.0.4/31&#39;
set protocols ospf interface eth1 network &#39;point-to-point&#39;
set protocols ospf interface eth2 network &#39;point-to-point&#39;
set protocols ospf interface eth1 passive disable
set protocols ospf interface eth2 passive disable
set protocols ospf log-adjacency-changes detail
set protocols ospf parameters abr-type &#39;cisco&#39;
set protocols ospf parameters router-id &#39;172.29.255.2&#39;
set protocols ospf passive-interface &#39;default&#39;
set protocols ospf redistribute connected

set protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set protocols bgp address-family l2vpn-evpn advertise-all-vni
set protocols bgp system-as &#39;100&#39;
set protocols bgp neighbor 172.29.255.1 peer-group &#39;ibgp&#39;
set protocols bgp neighbor 172.29.255.3 peer-group &#39;ibgp&#39;
set protocols bgp parameters log-neighbor-changes
set protocols bgp parameters router-id &#39;172.29.255.2&#39;
set protocols bgp peer-group ibgp address-family l2vpn-evpn
set protocols bgp peer-group ibgp remote-as &#39;100&#39;
set protocols bgp peer-group ibgp update-source &#39;dum0&#39;
</pre></div>
</div>
<p>PE3</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces dummy dum0 address &#39;172.29.255.3/32&#39;

set interfaces ethernet eth2 address &#39;172.29.0.5/31&#39;
set interfaces ethernet eth2 description &#39;link to pe2&#39;
set interfaces ethernet eth2 mtu &#39;1600&#39;
set interfaces ethernet eth3 address &#39;172.29.0.7/31&#39;
set interfaces ethernet eth3 description &#39;link to pe1&#39;
set interfaces ethernet eth3 mtu &#39;1600&#39;

set protocols ospf area 0 network &#39;172.29.0.4/31&#39;
set protocols ospf area 0 network &#39;172.29.0.6/31&#39;
set protocols ospf interface eth2 network &#39;point-to-point&#39;
set protocols ospf interface eth3 network &#39;point-to-point&#39;
set protocols ospf interface eth2 passive disable
set protocols ospf interface eth3 passive disable
set protocols ospf log-adjacency-changes detail
set protocols ospf parameters abr-type &#39;cisco&#39;
set protocols ospf parameters router-id &#39;172.29.255.3&#39;
set protocols ospf passive-interface &#39;default&#39;
set protocols ospf redistribute connected

set protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set protocols bgp address-family l2vpn-evpn advertise-all-vni
set protocols bgp system-as &#39;100&#39;
set protocols bgp neighbor 172.29.255.1 peer-group &#39;ibgp&#39;
set protocols bgp neighbor 172.29.255.2 peer-group &#39;ibgp&#39;
set protocols bgp parameters log-neighbor-changes
set protocols bgp parameters router-id &#39;172.29.255.3&#39;
set protocols bgp peer-group ibgp address-family l2vpn-evpn
set protocols bgp peer-group ibgp remote-as &#39;100&#39;
set protocols bgp peer-group ibgp update-source &#39;dum0&#39;
</pre></div>
</div>
</section>
<section id="tenant-networks-vrfs">
<h2>Tenant networks (VRFs)<a class="headerlink" href="#tenant-networks-vrfs" title="Link to this heading"></a></h2>
<p>Once all routers can be safely remotely managed and the core network is
operational, we can now setup the tenant networks.</p>
<p>Every tenant is assigned an individual VRF that would support overlapping
address ranges for customers blue, red and green. In our example,
we do not use overlapping ranges to make it easier when showing debug commands.</p>
<p>Thus you can easily match it to one of the devices/networks below.</p>
<p>Every router that provides access to a customer network needs to have the
customer network (VRF + VNI) configured. To make our own lives easier,
we utilize the same VRF table id (local routing table number) and
VNI (Virtual Network Identifier) per tenant on all our routers.</p>
<ul class="simple">
<li><p>blue uses local routing table id and VNI 2000</p></li>
<li><p>red uses local routing table id and VNI 3000</p></li>
<li><p>green uses local routing table id and VNI 4000</p></li>
</ul>
<p>PE1</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces vxlan vxlan2000 mtu &#39;1500&#39;
set interfaces vxlan vxlan2000 parameters nolearning
set interfaces vxlan vxlan2000 port &#39;4789&#39;
set interfaces vxlan vxlan2000 source-address &#39;172.29.255.1&#39;
set interfaces vxlan vxlan2000 vni &#39;2000&#39;

set vrf name blue protocols bgp address-family ipv4-unicast redistribute connected
set vrf name blue protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name blue protocols bgp system-as &#39;100&#39;
set vrf name blue table &#39;2000&#39;
set vrf name blue vni &#39;2000&#39;

set interfaces vxlan vxlan3000 mtu &#39;1500&#39;
set interfaces vxlan vxlan3000 parameters nolearning
set interfaces vxlan vxlan3000 port &#39;4789&#39;
set interfaces vxlan vxlan3000 source-address &#39;172.29.255.1&#39;
set interfaces vxlan vxlan3000 vni &#39;3000&#39;

set vrf name red protocols bgp address-family ipv4-unicast redistribute connected
set vrf name red protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name red protocols bgp system-as &#39;100&#39;
set vrf name red table &#39;3000&#39;
set vrf name red vni &#39;3000&#39;

set interfaces vxlan vxlan4000 mtu &#39;1500&#39;
set interfaces vxlan vxlan4000 parameters nolearning
set interfaces vxlan vxlan4000 port &#39;4789&#39;
set interfaces vxlan vxlan4000 source-address &#39;172.29.255.1&#39;
set interfaces vxlan vxlan4000 vni &#39;4000&#39;

set vrf name green protocols bgp address-family ipv4-unicast redistribute connected
set vrf name green protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name green protocols bgp system-as &#39;100&#39;
set vrf name green table &#39;4000&#39;
set vrf name green vni &#39;4000&#39;

set interfaces bridge br2000 address &#39;10.1.1.1/24&#39;
set interfaces bridge br2000 description &#39;customer blue&#39;
set interfaces bridge br2000 member interface eth4
set interfaces bridge br2000 member interface vxlan2000
set interfaces bridge br2000 vrf &#39;blue&#39;

set interfaces bridge br3000 address &#39;10.2.1.1/24&#39;
set interfaces bridge br3000 description &#39;customer red&#39;
set interfaces bridge br3000 member interface eth5
set interfaces bridge br3000 member interface vxlan3000
set interfaces bridge br3000 vrf &#39;red&#39;

set interfaces bridge br4000 address &#39;10.3.1.1/24&#39;
set interfaces bridge br4000 description &#39;customer green&#39;
set interfaces bridge br4000 member interface eth6
set interfaces bridge br4000 member interface vxlan4000
set interfaces bridge br4000 vrf &#39;green&#39;

set interfaces ethernet eth4 description &#39;customer blue&#39;
set interfaces ethernet eth5 description &#39;customer red&#39;
set interfaces ethernet eth6 description &#39;customer green&#39;
</pre></div>
</div>
<p>PE2</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces vxlan vxlan2000 mtu &#39;1500&#39;
set interfaces vxlan vxlan2000 parameters nolearning
set interfaces vxlan vxlan2000 port &#39;4789&#39;
set interfaces vxlan vxlan2000 source-address &#39;172.29.255.2&#39;
set interfaces vxlan vxlan2000 vni &#39;2000&#39;

set vrf name blue protocols bgp address-family ipv4-unicast redistribute connected
set vrf name blue protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name blue protocols bgp system-as &#39;100&#39;
set vrf name blue table &#39;2000&#39;
set vrf name blue vni &#39;2000&#39;

set interfaces vxlan vxlan3000 mtu &#39;1500&#39;
set interfaces vxlan vxlan3000 parameters nolearning
set interfaces vxlan vxlan3000 port &#39;4789&#39;
set interfaces vxlan vxlan3000 source-address &#39;172.29.255.2&#39;
set interfaces vxlan vxlan3000 vni &#39;3000&#39;

set vrf name red protocols bgp address-family ipv4-unicast redistribute connected
set vrf name red protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name red protocols bgp system-as &#39;100&#39;
set vrf name red table &#39;3000&#39;
set vrf name red vni &#39;3000&#39;

set interfaces vxlan vxlan4000 mtu &#39;1500&#39;
set interfaces vxlan vxlan4000 parameters nolearning
set interfaces vxlan vxlan4000 port &#39;4789&#39;
set interfaces vxlan vxlan4000 source-address &#39;172.29.255.2&#39;
set interfaces vxlan vxlan4000 vni &#39;4000&#39;

set vrf name green protocols bgp address-family ipv4-unicast redistribute connected
set vrf name green protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name green protocols bgp system-as &#39;100&#39;
set vrf name green table &#39;4000&#39;
set vrf name green vni &#39;4000&#39;

set interfaces bridge br2000 address &#39;10.1.2.1/24&#39;
set interfaces bridge br2000 description &#39;customer blue&#39;
set interfaces bridge br2000 member interface eth4
set interfaces bridge br2000 member interface vxlan2000
set interfaces bridge br2000 vrf &#39;blue&#39;

set interfaces bridge br3000 address &#39;10.2.2.1/24&#39;
set interfaces bridge br3000 description &#39;customer red&#39;
set interfaces bridge br3000 member interface eth5
set interfaces bridge br3000 member interface vxlan3000
set interfaces bridge br3000 vrf &#39;red&#39;

set interfaces ethernet eth4 description &#39;customer blue&#39;
set interfaces ethernet eth5 description &#39;customer red&#39;
</pre></div>
</div>
<p>PE3</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces vxlan vxlan2000 mtu &#39;1500&#39;
set interfaces vxlan vxlan2000 parameters nolearning
set interfaces vxlan vxlan2000 port &#39;4789&#39;
set interfaces vxlan vxlan2000 source-address &#39;172.29.255.3&#39;
set interfaces vxlan vxlan2000 vni &#39;2000&#39;

set vrf name blue protocols bgp address-family ipv4-unicast redistribute connected
set vrf name blue protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name blue protocols bgp system-as &#39;100&#39;
set vrf name blue table &#39;2000&#39;
set vrf name blue vni &#39;2000&#39;

set interfaces vxlan vxlan3000 mtu &#39;1500&#39;
set interfaces vxlan vxlan3000 parameters nolearning
set interfaces vxlan vxlan3000 port &#39;4789&#39;
set interfaces vxlan vxlan3000 source-address &#39;172.29.255.3&#39;
set interfaces vxlan vxlan3000 vni &#39;3000&#39;

set vrf name red protocols bgp address-family ipv4-unicast redistribute connected
set vrf name red protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name red protocols bgp system-as &#39;100&#39;
set vrf name red table &#39;3000&#39;
set vrf name red vni &#39;3000&#39;

set interfaces vxlan vxlan4000 mtu &#39;1500&#39;
set interfaces vxlan vxlan4000 parameters nolearning
set interfaces vxlan vxlan4000 port &#39;4789&#39;
set interfaces vxlan vxlan4000 source-address &#39;172.29.255.3&#39;
set interfaces vxlan vxlan4000 vni &#39;4000&#39;

set vrf name green protocols bgp address-family ipv4-unicast redistribute connected
set vrf name green protocols bgp address-family l2vpn-evpn advertise ipv4 unicast
set vrf name green protocols bgp system-as &#39;100&#39;
set vrf name green table &#39;4000&#39;
set vrf name green vni &#39;4000&#39;

set interfaces bridge br2000 address &#39;10.1.3.1/24&#39;
set interfaces bridge br2000 description &#39;customer blue&#39;
set interfaces bridge br2000 member interface eth4
set interfaces bridge br2000 member interface vxlan2000
set interfaces bridge br2000 vrf &#39;blue&#39;

set interfaces bridge br4000 address &#39;10.3.3.1/24&#39;
set interfaces bridge br4000 description &#39;customer green&#39;
set interfaces bridge br4000 member interface eth6
set interfaces bridge br4000 member interface vxlan4000
set interfaces bridge br4000 vrf &#39;green&#39;

set interfaces ethernet eth4 description &#39;customer blue&#39;
set interfaces ethernet eth6 description &#39;customer green&#39;
</pre></div>
</div>
</section>
<section id="testing-and-debugging">
<h2>Testing and debugging<a class="headerlink" href="#testing-and-debugging" title="Link to this heading"></a></h2>
<p>You managed to come this far, now we want to see the network and routing
tables in action.</p>
<p>Show routes for all VRFs</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@PE1:~$ show ip route vrf all
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

VRF blue:
C&gt;* 10.1.1.0/24 is directly connected, br2000, 00:01:13
B&gt;* 10.1.2.0/24 [200/0] via 172.29.255.2, br2000 onlink, weight 1, 00:00:49
B&gt;* 10.1.3.0/24 [200/0] via 172.29.255.3, br2000 onlink, weight 1, 00:00:49

VRF default:
O   172.29.0.2/31 [110/1] is directly connected, eth1, weight 1, 00:01:09
C&gt;* 172.29.0.2/31 is directly connected, eth1, 00:01:12
O&gt;* 172.29.0.4/31 [110/2] via 172.29.0.3, eth1, weight 1, 00:00:46
  *                       via 172.29.0.7, eth3, weight 1, 00:00:46
O   172.29.0.6/31 [110/1] is directly connected, eth3, weight 1, 00:01:09
C&gt;* 172.29.0.6/31 is directly connected, eth3, 00:01:12
C&gt;* 172.29.255.1/32 is directly connected, dum0, 00:01:14
O&gt;* 172.29.255.2/32 [110/20] via 172.29.0.3, eth1, weight 1, 00:00:50
O&gt;* 172.29.255.3/32 [110/20] via 172.29.0.7, eth3, weight 1, 00:00:45

VRF green:
C&gt;* 10.3.1.0/24 is directly connected, br4000, 00:01:13
B&gt;* 10.3.3.0/24 [200/0] via 172.29.255.3, br4000 onlink, weight 1, 00:00:49

VRF mgmt:
S&gt;* 0.0.0.0/0 [210/0] via 10.100.0.1, eth0, weight 1, 00:01:45
C&gt;* 10.100.0.0/24 is directly connected, eth0, 00:01:45

VRF red:
C&gt;* 10.2.1.0/24 is directly connected, br3000, 00:01:13
B&gt;* 10.2.2.0/24 [200/0] via 172.29.255.2, br3000 onlink, weight 1, 00:00:49
</pre></div>
</div>
<p>Information about Ethernet Virtual Private Networks</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@PE1:~$ show bgp l2vpn evpn
BGP table version is 1, local router ID is 172.29.255.1
Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal
Origin codes: i - IGP, e - EGP, ? - incomplete
EVPN type-1 prefix: [1]:[EthTag]:[ESI]:[IPlen]:[VTEP-IP]:[Frag-id]
EVPN type-2 prefix: [2]:[EthTag]:[MAClen]:[MAC]:[IPlen]:[IP]
EVPN type-3 prefix: [3]:[EthTag]:[IPlen]:[OrigIP]
EVPN type-4 prefix: [4]:[ESI]:[IPlen]:[OrigIP]
EVPN type-5 prefix: [5]:[EthTag]:[IPlen]:[IP]

   Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher: 10.1.1.1:5
*&gt; [5]:[0]:[24]:[10.1.1.0]
                    172.29.255.1             0         32768 ?
                    ET:8 RT:100:2000 Rmac:4e:bb:3c:ba:bd:a6
Route Distinguisher: 10.1.2.1:4
*&gt;i[5]:[0]:[24]:[10.1.2.0]
                    172.29.255.2             0    100      0 ?
                    RT:100:2000 ET:8 Rmac:26:07:da:eb:fc:ea
Route Distinguisher: 10.1.3.1:4
*&gt;i[5]:[0]:[24]:[10.1.3.0]
                    172.29.255.3             0    100      0 ?
                    RT:100:2000 ET:8 Rmac:26:98:28:24:6e:54
Route Distinguisher: 10.2.1.1:6
*&gt; [5]:[0]:[24]:[10.2.1.0]
                    172.29.255.1             0         32768 ?
                    ET:8 RT:100:3000 Rmac:50:00:00:01:00:05
Route Distinguisher: 10.2.2.1:5
*&gt;i[5]:[0]:[24]:[10.2.2.0]
                    172.29.255.2             0    100      0 ?
                    RT:100:3000 ET:8 Rmac:50:00:00:02:00:05
Route Distinguisher: 10.3.1.1:7
*&gt; [5]:[0]:[24]:[10.3.1.0]
                    172.29.255.1             0         32768 ?
                    ET:8 RT:100:4000 Rmac:50:00:00:01:00:06
Route Distinguisher: 10.3.3.1:6
*&gt;i[5]:[0]:[24]:[10.3.3.0]
                    172.29.255.3             0    100      0 ?
                    RT:100:4000 ET:8 Rmac:06:32:9d:22:55:8a

Displayed 7 out of 7 total prefixes
</pre></div>
</div>
<p>If we need to retrieve information about a specific host/network inside
the EVPN network we need to run</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@PE2:~$ show bgp l2vpn evpn 10.3.1.10
BGP routing table entry for 10.3.1.1:7:[5]:[0]:[24]:[10.3.1.0]
Paths: (1 available, best #1)
  Not advertised to any peer
  Route [5]:[0]:[24]:[10.3.1.0] VNI 4000
  Local
    172.29.255.1 (metric 20) from 172.29.255.1 (172.29.255.1)
      Origin incomplete, metric 0, localpref 100, valid, internal, best (First path received)
      Extended Community: RT:100:4000 ET:8 Rmac:50:00:00:01:00:06
      Last update: Thu May 11 13:31:13 2023
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tunnelbroker/tunnelbroker.html" class="btn btn-neutral float-left" title="Tunnelbroker.net (IPv6)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Wireguard/Wireguard.html" class="btn btn-neutral float-right" title="Wireguard" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html">Copyright</a> 2024, VyOS maintainers and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <head>
      <style>
          #branch-select-container {
              position: fixed;
              bottom: 10px;
              right: 10px;
              background-color: #f0f0f0;
              padding: 5px;
              border: 1px solid #ccc;
              border-radius: 5px;
          }
      </style>
  </head>
  <body>
      <div id="branch-select-container">
          <select id="branch-select">
              <option value="sagitta">Sagitta</option>
              <option value="circinus">Circinus</option>
          </select>
      </div>
      <script>
          // Define the branches
          const branches = ['sagitta', 'circinus'];
  
          // Get the current branch name from the URL
          const currentUrl = window.location.href;
          const currentBranch = branches.find(branch => currentUrl.includes(branch));
  
          // Set the selected option in the dropdown
          const branchSelect = document.getElementById('branch-select');
          branchSelect.value = currentBranch;
  
          // Add an event listener to the dropdown
          branchSelect.addEventListener('change', () => {
              const newBranch = branchSelect.value;
              const newUrl = currentUrl.replace(currentBranch, newBranch);
              window.location.href = newUrl;
          });
      </script>
  </body>


</body>
</html>