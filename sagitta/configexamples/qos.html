

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QoS example &mdash; VyOS 1.4.x (sagitta) documentation</title>
      <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../static/vyos-logo-icon.png"/>
      <script src="../static/jquery.js?v=5d32c60e"></script>
      <script src="../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../static/documentation_options.js?v=8f5ed1cd"></script>
      <script src="../static/doctools.js?v=9bcbadda"></script>
      <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../static/design-tabs.js?v=f930bc37"></script>
    <script src="../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Segment-routing IS-IS example" href="segment-routing-isis.html" />
    <link rel="prev" title="Inter-VRF Routing over VRF Lite" href="inter-vrf-routing-vrf-lite.html" />
    <style>#vyos-header-iframe{position:fixed;top:0;left:0;right:0;z-index:999999999;width:100%;border:none}</style>
    <style>#vyos-footer-iframe{width:100%;border:none}</style>
    <link href="../static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="../static/css/lists.css" rel="stylesheet" type="text/css">
    <link href="../static/css/hints.css" rel="stylesheet" type="text/css">
    <link href="../static/css/headers.css" rel="stylesheet" type="text/css">
    <link href="../static/css/breadcrumbs.css" rel="stylesheet" type="text/css">
    <link href="../static/css/linkButtons.css" rel="stylesheet" type="text/css">
    <link href="../static/css/text.css" rel="stylesheet" type="text/css">
    <link href="../static/css/leftSidebar.css" rel="stylesheet" type="text/css">
    <link href="../static/css/scrolls.css" rel="stylesheet" type="text/css">
    <link href="../static/css/tables.css" rel="stylesheet" type="text/css">
    <link href="../static/css/installation/running-on-bare-metal.css" rel="stylesheet" type="text/css">
    <link href="../static/css/code-snippets.css" rel="stylesheet" type="text/css">
    <link href="../static/css/separate-commands.css" rel="stylesheet" type="text/css">
    <link href="../static/css/configuration/index.css" rel="stylesheet" type="text/css">
    <link href="../static/css/datatables.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="text/javascript" charset="utf8" src="../static/js/datatables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/tables.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/codecopier.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/sidebar.js"></script>
    <script type="text/javascript" charset="utf8" src="../static/js/footer.js"></script>
    </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VyOS
              <img src="../static/vyos-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introducing/about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introducing/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation and Image Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html#configuration-overview">Configuration Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adminguide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/index.html">Operation Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../automation/index.html">VyOS Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Configuration Blueprints</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="zone-policy.html">Zone-Policy example</a></li>
<li class="toctree-l2"><a class="reference internal" href="bgp-ipv6-unnumbered.html">BGP IPv6 unnumbered with extended nexthop</a></li>
<li class="toctree-l2"><a class="reference internal" href="ospf-unnumbered.html">OSPF unnumbered with ECMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure-vpn-bgp.html">Route-Based Site-to-Site VPN to Azure (BGP over IKEv2/IPsec)</a></li>
<li class="toctree-l2"><a class="reference internal" href="azure-vpn-dual-bgp.html">Route-Based Redundant Site-to-Site VPN to Azure (BGP over IKEv2/IPsec)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ha.html">High Availability Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="wan-load-balancing.html">WAN Load Balancer examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="pppoe-ipv6-basic.html">PPPoE IPv6 Basic Setup for Home Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3vpn-hub-and-spoke.html">L3VPN for Hub-and-Spoke connectivity with VyOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="lac-lns.html">PPPoE over L2TP</a></li>
<li class="toctree-l2"><a class="reference internal" href="inter-vrf-routing-vrf-lite.html">Inter-VRF Routing over VRF Lite</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">QoS example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration-dcsp-and-shaper-using-qos">Configuration ‘dcsp’ and shaper using QoS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="segment-routing-isis.html">Segment-routing IS-IS example</a></li>
<li class="toctree-l2"><a class="reference internal" href="nmp.html">NMP example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#configuration-blueprints-autotest">Configuration Blueprints (autotest)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/build-vyos.html">Build VyOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/issues-features.html">Issues/Feature requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/upstream-packages.html">Upstream packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Write Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coverage.html">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VyOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Configuration Blueprints</a></li>
      <li class="breadcrumb-item active">QoS example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../sources/configexamples/qos.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="qos-example">
<span id="examples-qos"></span><h1>QoS example<a class="headerlink" href="#qos-example" title="Link to this heading"></a></h1>
<section id="configuration-dcsp-and-shaper-using-qos">
<h2>Configuration ‘dcsp’ and shaper using QoS<a class="headerlink" href="#configuration-dcsp-and-shaper-using-qos" title="Link to this heading"></a></h2>
<p>In this case, we’ll try to make a simple lab using QoS and the general ability of the VyOS system.
We recommend you to go through the main article about <a class="reference external" href="https://docs.vyos.io/en/latest/configuration/trafficpolicy/index.html">QoS</a> first.</p>
<p>Using the general schema for example:</p>
<a class="reference internal image-reference" href="../images/qos1.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos1.png" style="width: 80%;" />
</a>
<p>We have four hosts on the local network 172.17.1.0/24. All hosts are labeled CS0 by default. We need to replace labels on all hosts except vpc8.
We will replace the labels on the nearest router “VyOS3” using the IP addresses of the sources.</p>
<ul class="simple">
<li><p>172.17.1.2 CS0 -&gt; CS4</p></li>
<li><p>172.17.1.3 CS0 -&gt; CS5</p></li>
<li><p>172.17.1.4 CS0 -&gt; CS6</p></li>
<li><p>172.17.1.40 CS0 by default</p></li>
</ul>
<p>Next, we will replace only all CS4 labels on the “VyOS2” router.</p>
<ul class="simple">
<li><p>CS4 -&gt; CS5</p></li>
</ul>
<p>In the end, we will configure the traffic shaper using QoS mechanisms on the “VYOS2” router.</p>
</section>
<section id="configuration">
<h2>Configuration:<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<p>Set IP addresses on all VPCs and a default gateway 172.17.1.1. We’ll use in this case only static routes.
On the VyOS3 router, we need to change the ‘dscp’ labels for the VPCs. To do this, we use this configuration.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces ethernet eth0 address &#39;10.1.1.100/24&#39;
set interfaces ethernet eth1 address &#39;172.17.1.1/24&#39;
set protocols static route 0.0.0.0/0 next-hop 10.1.1.1
set qos policy shaper vyos3 class 10 match ADDRESS10 ip source address &#39;172.17.1.2/32&#39;
set qos policy shaper vyos3 class 10 set-dscp &#39;CS4&#39;
set qos policy shaper vyos3 class 20 match ADDRESS20 ip source address &#39;172.17.1.3/32&#39;
set qos policy shaper vyos3 class 20 set-dscp &#39;CS5&#39;
set qos policy shaper vyos3 class 30 match ADDRESS20 ip source address &#39;172.17.1.4/32&#39;
set qos policy shaper vyos3 class 30 set-dscp &#39;CS6&#39;
set qos policy shaper vyos3 default bandwidth &#39;10%&#39;
set qos policy shaper vyos3 default ceiling &#39;100%&#39;
set qos policy shaper vyos3 default priority &#39;7&#39;
set qos policy shaper vyos3 default queue-type &#39;fair-queue&#39;
set qos interface eth0 egress &#39;vyos3&#39;
</pre></div>
</div>
<p>Main rules:</p>
<ul class="simple">
<li><p>ADDRESS10 change CS0 -&gt; CS4 source 172.17.1.2/32</p></li>
<li><p>ADDRESS20 change CS0 -&gt; CS5 source 172.17.1.3/32</p></li>
<li><p>ADDRESS30 change CS0 -&gt; CS6 source 172.17.1.4/32</p></li>
</ul>
<p>Check the result</p>
<a class="reference internal image-reference" href="../images/qos2.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos2.png" style="width: 80%;" />
</a>
<p>Before the interface eth0 on router VyOS3</p>
<a class="reference internal image-reference" href="../images/qos3.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos3.png" style="width: 80%;" />
</a>
<p>After the interface eth0 on router VyOS3</p>
<a class="reference internal image-reference" href="../images/qos4.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos4.png" style="width: 80%;" />
</a>
<p>On the router, VyOS4 set all traffic as CS4. We have to configure the default class and class for changing all labels from CS0 to CS4</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces ethernet eth0 address &#39;10.2.1.100/24&#39;
set protocols static route 0.0.0.0/0 next-hop 10.2.1.1
set qos policy shaper vyos4 class 10 bandwidth &#39;100%&#39;
set qos policy shaper vyos4 class 10 burst &#39;15k&#39;
set qos policy shaper vyos4 class 10 match ALL ether protocol &#39;all&#39;
set qos policy shaper vyos4 class 10 queue-type &#39;fair-queue&#39;
set qos policy shaper vyos4 class 10 set-dscp &#39;CS4&#39;
set qos policy shaper vyos4 default bandwidth &#39;10%&#39;
set qos policy shaper vyos4 default burst &#39;15k&#39;
set qos policy shaper vyos4 default ceiling &#39;100%&#39;
set qos policy shaper vyos4 default priority &#39;7&#39;
set qos policy shaper vyos4 default queue-type &#39;fair-queue&#39;
set qos interface eth0 egress &#39;vyos4&#39;
</pre></div>
</div>
<p>Next on the router VyOS2 we will change labels on all incoming traffic only from CS4-&gt; CS6</p>
<a class="reference internal image-reference" href="../images/qos5.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos5.png" style="width: 80%;" />
</a>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set interfaces ethernet eth0 address &#39;10.1.1.1/24&#39;
set interfaces ethernet eth1 address &#39;10.2.1.1/24&#39;
set interfaces ethernet eth2 address &#39;10.9.9.1/24&#39;
set protocols static route 172.17.1.0/24 next-hop 10.1.1.100
set qos policy shaper vyos2 class 10 bandwidth &#39;100%&#39;
set qos policy shaper vyos2 class 10 burst &#39;15k&#39;
set qos policy shaper vyos2 class 10 match VYOS2 ip dscp &#39;CS4&#39;
set qos policy shaper vyos2 class 10 queue-type &#39;fair-queue&#39;
set qos policy shaper vyos2 class 10 set-dscp &#39;CS5&#39;
set qos policy shaper vyos2 default bandwidth &#39;100%&#39;
set qos policy shaper vyos2 default burst &#39;15k&#39;
set qos policy shaper vyos2 default ceiling &#39;100%&#39;
set qos policy shaper vyos2 default priority &#39;7&#39;
set qos policy shaper vyos2 default queue-type &#39;fair-queue&#39;
set qos interface eth2 egress &#39;vyos2&#39;
</pre></div>
</div>
<a class="reference internal image-reference" href="../images/qos6.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos6.png" style="width: 80%;" />
</a>
<ul class="simple">
<li><p>172.17.1.2/24 CS0</p></li>
</ul>
<a class="reference internal image-reference" href="../images/qos7.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos7.png" style="width: 80%;" />
</a>
<ul class="simple">
<li><p>172.17.1.2/24 CS0 - &gt; CS4</p></li>
</ul>
<a class="reference internal image-reference" href="../images/qos8.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos8.png" style="width: 80%;" />
</a>
<ul class="simple">
<li><p>172.17.1.2/24 CS4 - &gt; CS5</p></li>
</ul>
<a class="reference internal image-reference" href="../images/qos9.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos9.png" style="width: 80%;" />
</a>
<p>In the end, on the router “VyOS2” we will set outgoing bandwidth limits between the “VyOS3” and “VyOS1” routers. Let’s set a limit for IP 10.1.1.100 = 5 Mbps(Tx). We will check the result of the work with the help of the “iPerf” utility.</p>
<p>Set up bandwidth limits on the eth2 interface of the router “VyOS2”.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vyos@vyos2# show qos policy shaper vyos2 class 20
bandwidth 5mbit
description &quot;for VyOS3 eth0&quot;
match VyOS3 {
        ip {
                source {
                        address 10.1.1.100/32
                }
        }
}
</pre></div>
</div>
<p>Check the result.</p>
<a class="reference internal image-reference" href="../images/qos10.png"><img alt="Network Topology Diagram" class="align-center" src="../images/qos10.png" style="width: 80%;" />
</a>
<p>As we see shaper is working and the traffic will not work over 5 Mbit/s.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="inter-vrf-routing-vrf-lite.html" class="btn btn-neutral float-left" title="Inter-VRF Routing over VRF Lite" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="segment-routing-isis.html" class="btn btn-neutral float-right" title="Segment-routing IS-IS example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2023, VyOS maintainers and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>